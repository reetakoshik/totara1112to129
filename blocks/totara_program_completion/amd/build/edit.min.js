define(["jquery","core/config","core/str"],function(a,b,c){var d={blockid:null,programsselected:null,init:function(e,f){var g=a.Deferred(),h=this;d.blockid=e,d.programsselected=f,window.dialogsInited?g.resolve():(window.dialoginits instanceof Array||(window.dialoginits=[]),window.dialoginits.push(function(){g.resolve()}));var i=[];i.push({key:"save",component:"totara_core"}),i.push({key:"cancel",component:"moodle"}),i.push({key:"addprograms",component:"block_totara_program_completion"}),a.when(c.get_strings(i),g).done(function(a){for(var c=[],e=0;e<i.length;e++)c[i[e].key]=a[e];var f=b.wwwroot+"/blocks/totara_program_completion/",g=h._createDialog(),j=new g;j.baseurl=f;var k={};k[c.save]=function(){j._update()},k[c.cancel]=function(){j._cancel()},totaraDialogs.addblockprograms=new totaraDialog("addblockprograms","add-block-programs-dialog",{buttons:k,title:"<h2>"+c.addprograms+"</h2>"},f+"findprograms.php?selected="+d.programsselected+"&blockid="+d.blockid+"&sesskey="+b.sesskey,j)})},_createDialog:function(){var c=function(){this.baseurl="",this.program_items=a('input:hidden[name="config_programids"]').val(),this.program_items=this.program_items&&this.program_items.length>0?this.program_items.split(","):[],this.program_table=a("#block-programs-table"),this.add_program_delete_event_handlers(),this.check_table_hidden_status()};return c.prototype=new totaraDialog_handler_treeview_multiselect,c.prototype._update=function(c){var d=this,e=a(".selected > div > span",this._container),f=this._get_ids(e),g=f.join(","),h=this._dialog.default_url.split("selected="),i=h[1].slice(h[1].indexOf("&"));this._dialog.default_url=h[0]+"selected="+g+i;var j=[];if(a(f).each(function(a,b){d.program_item_exists(b)||(j.push(b),d.add_program_item(b))}),j.length>0){this._dialog.showLoading();var k=b.wwwroot+"/blocks/totara_program_completion/program_item.php?itemid="+j.join(",")+i;a.getJSON(k,function(b){return b.error?(d._dialog.hide(),void alert(b.error)):(a.each(b.items,function(a,b){d.create_item(b)}),void d._dialog.hide())})}else this._dialog.hide()},c.prototype.program_item_exists=function(a){for(var b in this.program_items)if(this.program_items[b]==a)return!0;return!1},c.prototype.check_table_hidden_status=function(){0==this.program_items.length?a(this.program_table).hide():a(this.program_table).show()},c.prototype.add_program_delete_event_handlers=function(){a(".blockprogramdeletelink",this.program_table).unbind("click");var b=this;this.program_table.on("click",".blockprogramdeletelink",function(a){a.preventDefault(),b.remove_program_item(this)})},c.prototype.add_program_item=function(b){this.program_items.push(b),a('input:hidden[name="config_programids"]').val(this.program_items.join(",")),this.check_table_hidden_status()},c.prototype.create_item=function(b){var c=a(b);this.program_table.append(c)},c.prototype.remove_program_item=function(b){var c=a(b).closest("li"),d=c.data("progid");this.program_items=a.grep(this.program_items,function(a,b){return a==d},!0),c.remove(),this.check_table_hidden_status(),a('input:hidden[name="config_programids"]').val(this.program_items.join(","));var e=this._dialog.default_url.split("selected="),f=e[1].slice(e[1].indexOf("&"));this._dialog.default_url=e[0]+"selected="+this.program_items.join(",")+f},c}};return d});