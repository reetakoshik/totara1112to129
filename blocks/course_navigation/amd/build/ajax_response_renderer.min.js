define(["jquery","core/templates"],function(a,b){function c(e,f){var g=a("<ul></ul>");g.attr("role","group"),g.attr("aria-hidden",!0),a.each(f,function(e,f){if("object"==typeof f){var h=a("<li></li>"),i=a("<p></p>"),j=f.id||f.key+"_tree_item",k=null,l=!(!f.expandable&&!f.haschildren);if(i.addClass("tree_item"),i.attr("id",j),i.attr("role","treeitem"),i.attr("tabindex","-1"),f.requiresajaxloading&&(i.attr("data-requires-ajax",!0),i.attr("data-node-id",f.id),i.attr("data-node-key",f.key),i.attr("data-node-type",f.type)),l&&(h.addClass("collapsed contains_branch"),i.attr("aria-expanded",!1),i.addClass("branch"),b.renderIcon("collapsed").done(function(a){"false"===i.attr("aria-expanded")&&(i.find(".flex-icon").remove(),i.prepend(a))})),f.icon&&(!l||f.type===d.ACTIVITY||f.type===d.RESOURCE)){h.addClass("item_with_icon"),i.addClass("hasicon");var m=f.flex_icon;"string"==typeof m?k=a(m):(k=a("<img/>"),k.attr("alt",f.icon.alt),k.attr("title",f.icon.title),k.attr("src",M.util.image_url(f.icon.pix,f.icon.component)),a.each(f.icon.classes,function(a,b){k.addClass(b)}))}if(f.link){var n=a('<a title="'+f.title+'" href="'+f.link+'"></a>');k?(n.append(k),n.append('<span class="item-content-wrap">'+f.name+"</span>")):n.append(f.name),f.hidden&&n.addClass("dimmed"),i.append(n)}else{var o=a("<span></span>");k?(o.append(k),o.append('<span class="item-content-wrap">'+f.name+"</span>")):o.append(f.name),f.hidden&&o.addClass("dimmed"),i.append(o)}h.append(i),g.append(h),f.children&&f.children.length?c(i,f.children):l&&!f.requiresajaxloading&&(h.removeClass("contains_branch"),i.addClass("emptybranch"),b.renderIcon("collapsed-empty").done(function(a){"true"===i.attr("aria-expanded")&&(i.find(".flex-icon").remove(),i.prepend(a))}))}}),e.parent().append(g);var h=e.attr("id")+"_group";g.attr("id",h),e.attr("aria-owns",h),e.attr("role","treeitem")}var d={ACTIVITY:40,RESOURCE:50};return{render:function(a,d){if(d.children&&d.children.length){c(a,d.children);var e=a.children("[role='treeitem']").first(),f=a.find("#"+e.attr("aria-owns"));e.attr("aria-expanded",!0),f.attr("aria-hidden",!1)}else a.parent().hasClass("contains_branch")&&(a.parent().removeClass("contains_branch"),b.renderIcon("collapsed-empty").done(function(b){"true"===a.attr("aria-expanded")&&(a.find(".flex-icon").remove(),a.prepend(b))}))}}});