define(["jquery","core/str","core/config","core/templates","core/modal_factory","core/modal_events","totara_contentmarketplace/filters"],function(a,b,c,d,e,f,g){var h="create-course",i={};return i.selector=null,i.haveQueriedOrSortedAtLeastOnce=!1,i.selected=[],i.totalResults=0,i.maxSelectAll=1e4,i.maxCreateCourse=100,i.warnCreateCourse=11,i.filters=null,i.lockId=0,i.createpagepath="",i.init=function(b){var c=this,d=a(b);this.selector=b,this.createpagepath=d.data("createpagepath"),this.marketplace=d.data("marketplace"),this.mode=d.data("mode"),this.mode===h&&a(".tcm-collection-tool",this.selector).hide(),this.category=d.data("category"),a(".tcm-sorting select",d).on("change",this,function(a){a.preventDefault(),a.data.sort()}),a(".tcm-search_query form",d).on("submit",this,function(a){a.preventDefault(),a.data.search()}),this.filters=new g(b,this.search.bind(this),this.marketplace,this.mode,this.category),a(".tcm-load-more button",d).on("click",this,function(a){a.preventDefault(),a.data.more()}),d.on("change",".tcm-thumbnail_selection input",this,function(b){b.preventDefault(),a(b.target).is(":checked")?c.addToSelection(a(b.target).val()):c.removeFromSelection(a(b.target).val())}),d.on("click",".tcm-thumbnail_selection label, .tcm-thumbnail_selection input",function(a){a.stopPropagation()}),d.on("click",".tcm-search-thumbnail",function(b){b.preventDefault();var d=a(this).find("input").val();c.showDetails(d)}),a(".tcm-search_selection_tools",d).on("click",".tcm-create-course.tcm-tool-enabled",this,function(a){a.preventDefault(),a.data.createCourse()}),a(".tcm-add-to-collection",d).on("click",this,function(a){a.preventDefault(),a.data.addToCollection()}),a(".tcm-remove-from-collection",d).on("click",this,function(a){a.preventDefault(),a.data.removeFromCollection()}),a(".tcm-select-all",d).on("click",this,function(a){a.preventDefault(),a.data.selectAll()}),a(".tcm-deselect-all",d).on("click",this,function(a){a.preventDefault(),a.data.deselectAll()}),this.search()},i.sort=function(){this.haveQueriedOrSortedAtLeastOnce=!0,this.search()},i.search=function(){var b,e,f=a(this.selector),g=this,i=this.lock();f.addClass("tcm-is-searching"),a(".tcm-search_result_summary",f).html(""),b=a(".tcm-search_query input",f).val().trim(),e={sesskey:c.sesskey,page:0,query:b,sort:a(".tcm-sorting select",f).val(),multivaluefilters:[],singlevaluefilters:[],marketplace:this.marketplace,category:this.category,mode:this.mode},this.haveQueriedOrSortedAtLeastOnce||""===b||(this.haveQueriedOrSortedAtLeastOnce=!0,e.isfirstquerywithdefaultsort=!0),a.each(this.filters.getValues(),function(a,b){b instanceof Array?e.multivaluefilters.push(a):e.singlevaluefilters.push(a),e["filter-"+a]=b}),this.data=e,a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/search.php",data:e}).done(function(b){g.totalResults=b.total,d.render("totara_contentmarketplace/results",b).done(function(c){g.checkLock(i)&&(c=a(c),a(".tcm-thumbnail_selection input",c).each(function(){g.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),a(".tcm-results").replaceWith(c),b.more?(a(".tcm-load-more",f).removeClass("tcm-load-more-loading"),a(".tcm-load-more button",f).prop("disabled",!1),a(".tcm-load-more",f).show()):a(".tcm-load-more",f).hide(),g.initResizeHandler())}),g.checkLock(i)&&g.filters.setCounts(b.filters),d.render("totara_contentmarketplace/result_summary",b).done(function(b){g.checkLock(i)&&(f.removeClass("tcm-is-searching"),a(".tcm-search_result_summary",f).replaceWith(b))}),a(".tcm-sorting select",f).val(b.sort),g.mode!==h&&("add"===b.selectionmode?(a(".tcm-add-to-collection",f).show(),a(".tcm-remove-from-collection",f).hide()):"remove"===b.selectionmode&&(a(".tcm-add-to-collection",f).hide(),a(".tcm-remove-from-collection",f).show()))})},i.more=function(){var b,e=a(this.selector),f=this,g=this.lock();a(".tcm-load-more",e).addClass("tcm-load-more-loading"),a(".tcm-load-more button",e).prop("disabled",!0),b=this.data,b.page+=1,a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/search.php",data:b}).done(function(b){d.render("totara_contentmarketplace/results",b).done(function(c){f.checkLock(g)&&(c=a(c),a(".tcm-thumbnail_selection input",c).each(function(){f.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),a("> div",c).appendTo(".tcm-results"),b.more?(a(".tcm-load-more",e).removeClass("tcm-load-more-loading"),a(".tcm-load-more button",e).prop("disabled",!1),a(".tcm-load-more",e).show()):a(".tcm-load-more",e).hide(),f.initResizeHandler())})})},i.addToSelection=function(a){var b=this.selected.indexOf(a);b<0&&this.selected.push(a),this.selection()},i.removeFromSelection=function(a){var b=this.selected.indexOf(a);b>-1&&this.selected.splice(b,1),this.selection()},i.selection=function(){var c=a(this.selector);if(this.selected.length>0){var d=this,e=this.selected.length,f=1===e?"itemselected":"itemselected_plural",g=a(".tcm-search_selection_status",c);b.get_string(f,"totara_contentmarketplace",e).done(function(b){d.selected.length===e&&(g.text(b),a(".tcm-search_selection_tools",c).css("visibility","visible"))})}else a(".tcm-search_selection_tools",c).css("visibility","hidden")},i.selectAll=function(){var b=this;b.totalResults>b.maxSelectAll?b.warningTooManySelectAll():(a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/select.php",data:this.data}).done(function(c){a(".tcm-select-all").siblings(".tcm-loading").css({visibility:"hidden"}),b.selected=b.selected.concat(c.selection.filter(function(a){return b.selected.indexOf(a)<0})),a(".tcm-thumbnail_selection input").each(function(){b.selected.indexOf(a(this).val())>=0&&a(this).prop("checked",!0)}),b.selection()}),a(".tcm-select-all").siblings(".tcm-loading").css({visibility:"visible"}))},i.deselectAll=function(){this.selected=[];var b=a(this.selector);a(".tcm-thumbnail_selection input:checked",b).prop("checked",!1),this.selection()},i.createCourse=function(){this.selected.length>this.maxCreateCourse?(this.disableCreateCourse(),this.warningCreateTooManyCourses()):this.selected.length>=this.warnCreateCourse?(this.disableCreateCourse(this.selected),this.warningCreateLotsOfCourses(this.openCreateCourseForm.bind(this,this.selected))):this.openCreateCourseForm(this.selected)},i.openCreateCourseForm=function(b){var d={category:this.category,selection:b,mode:this.mode};this.disableCreateCourse(),window.location=c.wwwroot+this.createpagepath+"?"+a.param(d)},i.addToCollection=function(){var b=this,d=a(b.selector);d.addClass("tcm-is-searching"),a(".tcm-search_selection_tools",d).css("visibility","hidden"),a(".tcm-search_result_summary",d).html(""),a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/update_collection.php",data:{sesskey:c.sesskey,selection:this.selected,action:"add",marketplace:this.marketplace}}).done(function(a){b.search()}),b.selected=[]},i.removeFromCollection=function(){var b=this,d=a(b.selector);d.addClass("tcm-is-searching"),a(".tcm-search_selection_tools",d).css("visibility","hidden"),a(".tcm-search_result_summary",d).html(""),a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/update_collection.php",data:{sesskey:c.sesskey,selection:this.selected,action:"remove",marketplace:this.marketplace}}).done(function(a){b.search()}),b.selected=[]},i.warningTooManySelectAll=function(){var a=[{key:"warningtoomanyselectall:title",component:"totara_contentmarketplace"},{key:"warningtoomanyselectall:body",component:"totara_contentmarketplace"}];b.get_strings(a).done(function(a){e.create({type:e.types.CANCEL,title:a[0],body:a[1]}).done(function(a){a.show()})})},i.warningCreateTooManyCourses=function(){var a=this,c=[{key:"warningcreatetoomanycourses:title",component:"totara_contentmarketplace"},{key:"warningcreatetoomanycourses:body",component:"totara_contentmarketplace"}];b.get_strings(c).done(function(b){e.create({type:e.types.CANCEL,title:b[0],body:b[1]}).done(function(b){var c=b.getRoot();c.on(f.hidden,a.enableCreateCourse),b.show()})})},i.warningCreateLotsOfCourses=function(a){var c=this,d=[{key:"warningcreatelotsofcourses:title",component:"totara_contentmarketplace"},{key:"warningcreatelotsofcourses:body",component:"totara_contentmarketplace",param:this.selected.length},{key:"createcourses",component:"totara_contentmarketplace",param:this.selected.length},{key:"cancel"}];b.get_strings(d).done(function(b){e.create({type:e.types.CONFIRM,title:b[0],body:b[1]},void 0,{yesstr:b[2],nostr:b[3]}).done(function(b){var d=b.getRoot();d.on(f.yes,a),d.on(f.hidden,c.enableCreateCourse),b.show()})})},i.enableCreateCourse=function(){a(".tcm-create-course").addClass("tcm-tool-enabled")},i.disableCreateCourse=function(){a(".tcm-create-course").removeClass("tcm-tool-enabled")},i.showDetails=function(b){var e=this;e.hideDetails(),a(".tcm-result").removeClass("tcm-details-target"),a("#selection-"+b).closest(".tcm-result").addClass("tcm-details-target");var f=this.data;f.id=b,a("#tcm-details-wrapper-actual").length||a(".tcm-details-wrapper").clone().insertAfter(".tcm-results").attr("id","tcm-details-wrapper-actual");var g=a("#tcm-details-wrapper-actual");if(a(".tcm-details-content").remove(),g.show(),a(".tcm-preloader").show(),e.positionDetails(),!e.isElementInViewport(g[0])){var h=g[0].getBoundingClientRect();window.scrollBy({top:h.bottom-window.innerHeight,behavior:"smooth"})}a.post({url:c.wwwroot+"/totara/contentmarketplace/ajax/fetch_details.php",data:f}).done(function(c){d.render("totara_contentmarketplace/details",c).done(function(c){b===a(".tcm-details-target").find("input").val()&&(a(".tcm-preloader").hide(),a(".tcm-details-content").remove(),a(c).insertAfter(".tcm-preloader"),a(".tcm-details-close").click(e.hideDetails),a(".tcm-create-course-button").click(function(){e.openCreateCourseForm([b])}))})})},i.positionDetails=function(){var b=a("#tcm-details-wrapper-actual"),c=a(".tcm-details-target",this.selector);if(b.length&&c.length){var d=c.offset().left+Math.round(c.width()/2);a(".tcm-details-pointer").offset({left:d});var e=c;c.hasClass("tcm-last")||(e=c.nextAll(".tcm-last:first")),b.detach().insertAfter(e)}},i.hideDetails=function(){a("#tcm-details-wrapper-actual",this.selector).remove(),a(".tcm-result").removeClass("tcm-details-target")},i.initResizeHandler=function(){var b=this;a(window).on("resize",function(){if(a(".tcm-result").length){var c=a("#tcm-details-wrapper-actual");c.length&&a("#tcm-details-wrapper-actual").hide();var d=a(".tcm-result:first",b.selector).position().left;a(".tcm-result",b.selector).removeClass("tcm-last"),a(".tcm-result").each(function(){if(a(this).position().left===d){var b=a(this).prev();b.hasClass("tcm-details-wrapper")&&(b=b.prev()),b.addClass("tcm-last")}}),a(".tcm-result:last").addClass("tcm-last"),c.length&&a("#tcm-details-wrapper-actual").show(),b.positionDetails()}}),a(window).trigger("resize")},i.isElementInViewport=function(a){var b=a.getBoundingClientRect();return b.top>=0&&b.left>=0&&b.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&b.right<=(window.innerWidth||document.documentElement.clientWidth)},i.lock=function(){return++this.lockId},i.checkLock=function(a){return this.lockId===a},i});