define(["jquery","core/templates"],function(a,b){function c(a,b,c,d){this.name="",this.context=null,this.data={},this.selection=[],this.onFitler=null,this.showCounts=!1,this.init(a,b,c,d)}return c.prototype.init=function(b,c,d,e){this.name=b,this.showCounts=c,this.context=a(d),this.onFilter=e,this.context.on("keyup",".tcm-search-filter-term",this,function(a){"Escape"!==a.key&&setTimeout(function(){a.data.updateSearch()},1)}),this.context.on("focus",".tcm-search-filter-term",this,function(a){a.data.updateSearch(),a.data.showMenu()}),this.context.on("change",".tcm-checkbox-filter input",this,function(a){a.preventDefault(),a.data.onChange(a.currentTarget)})},c.prototype.populate=function(b){this.data=b.options,this.selection=[],a.isEmptyObject(b.options)&&this.context.hide()},c.prototype.showMenu=function(){a("body").on("keydown.tcm-filter-"+this.name,this,this.hideIfEscape),a("body").on("click.tcm-filter-"+this.name,this,this.hideIfOutside),a("body").on("focus.tcm-filter-"+this.name,"*",this,this.hideIfOutside),this.context.addClass("focused")},c.prototype.hideMenu=function(){a("body").off("keydown.tcm-filter-"+this.name),a("body").off("click.tcm-filter-"+this.name),a("body").off("focus.tcm-filter-"+this.name),this.context.removeClass("focused"),a(".tcm-search-filter-term",this.context).val(""),a(".tcm-search-filter-results",this.context).hide()},c.prototype.hideIfEscape=function(b){var c=b.data;"Escape"===b.key&&(a(".tcm-search-filter-term",c.context).trigger("blur"),c.hideMenu())},c.prototype.hideIfOutside=function(b){var c=b.data;a.contains(a(".tcm-search-filter-widget",c.context)[0],b.target)||c.hideMenu()},c.prototype.updateSearch=function(){var c,d,e=this,f=[];d=a(".tcm-search-filter-term",this.context).val(),d=d.trim().toLowerCase(),a.each(this.search(d),function(a,b){e.selection.indexOf(b)===-1&&f.push(e.data[b])}),0===f.length?a(".tcm-search-filter-results",e.context).hide():(c={results:f},b.render("totara_contentmarketplace/filter_checkboxes_searchable_results",c).done(function(b){a(".tcm-search-filter-results",e.context).html(b),a(".tcm-search-filter-results",e.context).show()}))},c.prototype.updateSelection=function(){var c,d=this,e=[],f=a.Deferred();return this.selection.forEach(function(a){var b=Object.assign({},d.data[a]);b.htmlid+="-selected",e.push(b)}),c={results:e},b.render("totara_contentmarketplace/filter_checkboxes_searchable_results",c).done(function(a){f.resolve(a)}),f.done(function(b){a(".tcm-search-filter-selection-wrapper",d.context).html(b)}),f.promise()},c.prototype.search=function(b){var c=this,d=new RegExp(c.escapeRegex(b),"i");return a.grep(Object.keys(c.data),function(a){return d.test(c.data[a].label)})},c.prototype.escapeRegex=function(a){return a.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")},c.prototype.onChange=function(b){var c=this,d=a(b).val(),e=a(b).is(":checked"),f=this.selection.indexOf(d);e?(f===-1&&this.selection.push(d),this.data[d].checked=!0):(f!==-1&&this.selection.splice(f,1),this.data[d].checked=!1);var g=this.updateSelection();this.onFilter(),e&&g.done(function(){var d;a(b).parent().hide(),d=0!==a(".tcm-search-filter-results .tcm-checkbox-filter:visible",c.context).length,a(".tcm-search-filter-results",c.context).toggle(d)})},c.prototype.getValue=function(){return this.selection},c.prototype.setCounts=function(b){if(this.showCounts){var c=this;for(var d in this.data)this.data[d].count="0";for(var d in b)d in this.data&&(this.data[d].count=b[d]);a(".tcm-filter-option-count",this.context).each(function(b,d){var e=a(d).data("value");a(d).text(c.data[e].count)})}},c});