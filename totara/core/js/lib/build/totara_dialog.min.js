function totaraDialog(a,b,c,d,e){this.title=a,this.buttonid=b,this.dialog,this.default_url=d,this.url="",this.config=c,this.handler=e,this.setup=function(){var a=this,b=.8*$(window).height(),c=.8*$(window).width();c=Math.max(c,$(window).width()-50),c=Math.min(c,800);var d={autoOpen:!1,closeOnEscape:!0,draggable:!1,height:b,width:c+"px",modal:!0,resizable:!1,zIndex:1500,dialogClass:"totara-dialog",open:function(){$(this).parent().find("span.ui-dialog-title").html("<span class='title'>"+a.config.title+"</span>")}};$('<div class="totara-dialog" style="display: none;"><div id="'+this.title+'"></div></div>').appendTo($("body")),this.dialog=$("#"+this.title).dialog($.extend(d,this.config)),void 0!=this.handler&&this.handler._setup(this),$("#"+this.title).on("dialogclose",function(b){b.preventDefault(),a.hide(),$(".selectionlimiterror").remove()}),$(document).on("click","#"+this.buttonid,function(b){b.preventDefault(),a.open()}),$.ui.dialog.prototype._focusTabbable=function(){}},this.open=function(){this.dialog.html(""),this.dialog.dialog("open");var a=this.dialog.parent(),b=a.height()-$("div.ui-dialog-titlebar",a).height()-$("div.ui-dialog-buttonpane",a).height()-36;this.dialog.height(b),void 0!=this.handler._open&&this.handler._open(),this.load(this.default_url)},this.load=function(a,b,c){this.dialog.html(""),this.showLoading(),"function"==typeof a?this.url=a():this.url=a,this._request(this.url,{},b,c)},this.error=function(a,b,c){b?(a.hideLoading(),a.dialog.html(b)):require(["core/str"],function(b){b.get_string("error:dialoggenericerror","totara_core").done(function(b){a.hideLoading(),a.dialog.html('<div class="box errorbox errorboxcontent">'+b+"</div>")})})},this.render=function(a,b){this.hideLoading(),b?b.html(a):this.dialog.html(a),this.bindLinks(),this.bindForms(),this.handler._load(),b&&void 0!=this.handler._partial_load&&this.handler._partial_load(b)},this.bindLinks=function(){var a=this;$("a",this.dialog).each(function(){0==$(this).parents(".dialog-nobind").length&&($(this).parent().is("span.helplink")||$(this).parent().is("span.helptooltip")||$(this).on("click",function(b){var c=$(this).attr("href"),d=$(this).parents(".dialog-load-within").slice(0,1);return 0!=d.length?(a.showLoading(),a._request(c,{outputelement:d})):a.load(c),b.preventDefault(),!1}))})},this.bindForms=function(){var a=this;$("form",this.dialog).each(function(){$(this).on("submit",function(b){var c=$(this).attr("action"),d=$(this).attr("method"),e=$(this).serialize(),f=$(this).parents(".dialog-load-within").slice(0,1);return 0!=f.length?(a.showLoading(),a._request(c,{outputelement:f},d,e)):a.load(c,d,e),b.preventDefault(),!1})})},this.showLoading=function(){$("div#"+this.title).addClass("yui-isloading")},this.hideLoading=function(){$("div#"+this.title).removeClass("yui-isloading")},this.hide=function(){this.handler._loaded=!1,this.dialog.html(""),this.dialog.dialog("isOpen")&&this.dialog.dialog("close")},this._request=function(a,b,c,d){var e=this;void 0==c&&(c="POST"),$.ajax({url:a,type:c,data:d,dataType:"html",success:function(a){var c=!0;void 0!=b&&void 0!=b.object&&(c=b.object[b.method](a,b.data)),c&&(void 0!=b&&void 0!=b.outputelement?e.render(a,b.outputelement):e.render(a),e.dialog.find("a:visible, input:visible, select:visible, button:visible").length>0?e.dialog.find("a:visible, input:visible, select:visible, button:visible")[0].focus():e.dialog.parent().find(".ui-dialog-buttonpane button")[0].focus())},error:function(b){e.error(e,b.responseText,a)}})},this.setup()}function totaraDialog_handler(){}M.totara_dialog=M.totara_dialog||{Y:null,config:{},init:function(a,b){if(this.Y=a,b){var c=a.JSON.parse(b);for(var d in c)a.Object.owns(c,d)&&(this.config[d]=c[d])}if("undefined"==typeof $)throw new Error("M.totara_dialog.init()-> jQuery dependency required for this module to function.")}},navigator.userAgent.match(/mozilla/i)&&$("body").addClass("mozilla");var totaraDialogs={};totaraDialog_handler.prototype._setup=function(a){this._dialog=a,this._title=a.title},totaraDialog_handler.prototype._load=function(a){if(!this._loaded){this._container=$("#"+this._title),void 0!=this.first_load&&this.first_load();var b=this._container.height(),c=parseFloat($(".select h3",this._container).css("margin-bottom"),10)||0,d=parseFloat($("#dialog-tabs",this._container).css("margin-bottom"),10)||0,e=b-$(".select h3",this._container).outerHeight(!0)-$(".select .tabs",this._container).outerHeight(!0)-($("#dialog-tabs").outerHeight(!0)-$("#dialog-tabs").height())+Math.min(c,d);$("#browse-tab").outerHeight(e),$("#search-tab").outerHeight(e),$(".selected.dialog-nobind",this._container).outerHeight(this._container.height()),this._loaded=!0}return void 0!=this.every_load&&this.every_load(),!0},totaraDialog_handler.prototype._update=function(a){$(".noitems-"+this._title).remove(),this._dialog.hide();var b=$("div.list-"+this._title);b.replaceWith(a),$(".totara-noscript",$("div.list-"+this._title)).hide()},totaraDialog_handler.prototype._get_ids=function(a,b){var c=[];return a.each(function(a){var b=$(this).attr("id").split("_");b="personal"==b[b.length-2]?"p"+b[b.length-1]:b[b.length-1],c.push(b)}),c},totaraDialog_handler.prototype._save=function(a){var b=$(".selected > div > span",this._container),c=this._get_ids(b).join(",");a+=c,this._dialog._request(a,{object:this,method:"_update"})},totaraDialog_handler.prototype._cancel=function(){this._dialog.hide()},totaraDialog_handler.prototype._set_framework=function(){var a=$(".simpleframeworkpicker option:selected",this._container).val(),b=this._dialog.url;if(b.indexOf("&frameworkid=")==-1||b.indexOf("?frameworkid=")==-1)b=b+"&frameworkid="+a+"&treeonly=1&switchframework=1";else{var c=b.indexOf("frameworkid=")+12,d=b.indexOf("&",c);b=d==-1?b.substring(0,c)+a:b.substring(0,c)+a+b.substring(d)}this._dialog.showLoading(),this._dialog._request(b,{outputelement:$("#browse-tab .treeview-wrapper",this._container)})},totaraDialog_handler.prototype._set_plan=function(){var a=$(".planselector option:selected",this._container).val(),b=this._dialog.url;b=b+"&planid="+a+"&treeonly=1&switchplan=1",this._dialog.showLoading(),this._dialog._request(b,{outputelement:$("#browse-tab .treeview-wrapper",this._container)})},totaraDialog_handler_treeview=function(){},totaraDialog_handler_treeview.prototype=new totaraDialog_handler,totaraDialog_handler_treeview.prototype.setup_tabs=function(a,b){$(".select",this._container);b&&"search-tab"===$(b.newTab).attr("aria-controls")&&$("#id_query",this._container).focus()},totaraDialog_handler_treeview.prototype.first_load=function(){var a=this;$(".treeview",this._container).treeview({prerendered:!0}),$("#dialog-tabs").tabs({selected:0,show:a.setup_tabs,activate:a.setup_tabs}),this.setup_tabs(),$(".simpleframeworkpicker",this._container).off("change"),$(".simpleframeworkpicker",this._container).change(function(){a._set_framework()}),$(".planselector",this._container).off("change"),$(".planselector",this._container).change(function(){a._set_plan()}),this._make_hierarchy($(".treeview",this._container)),$(".selected > div > span a",this._container).off("click").click(function(a){a.preventDefault()})},totaraDialog_handler_treeview.prototype._partial_load=function(a){if(this.setup_tabs(),a.hasClass("treeview"))var b=a;else var b=$(".treeview",a);return b.length&&b.treeview({prerendered:!0}),this._make_hierarchy(a),$(".selected > div > span a",a).off("click").click(function(a){a.preventDefault()}),void 0!=this.every_load&&this.every_load(),!0},totaraDialog_handler_treeview.prototype._make_hierarchy=function(a){var b=this;$("span.expandonly",a).each(function(){var a=$(this).attr("id"),c=$(".treeview",b._container).find("span#"+a);$("a",c).off("click"),$("a",c).click(function(a){a.preventDefault()})}),$("span.folder, div.hitarea, span.expandonly",a).on("click",function(){var a=$(this).parent();if($("> ul > li",a).length)return!1;var c=a.attr("id").substr(10),d=b._dialog.url+"&parentid="+c;return b._dialog._request(d,{object:b,method:"_update_hierarchy",data:c}),!1}),$("span.unclickable",a).each(function(){b._toggle_items($(this).attr("id"),!1)}),$(".selected > div > span",this._container).each(function(){var a=$(this).attr("id");b._toggle_items(a,!1)})},totaraDialog_handler_treeview.prototype._update_hierarchy=function(a,b){var c=a,d=$("#browse-tab .treeview li#item_list_"+b+" ul:first",this._container);$("li",d).remove();var e=$("#browse-tab .treeview",this._container);e.treeview({add:d.append($(c))}),this._make_hierarchy(d),void 0!=this._handle_update_hierarchy&&this._handle_update_hierarchy(d)},totaraDialog_handler_treeview.prototype._toggle_items=function(a,b){var c=this,d=$(".treeview",this._container).find("span#"+a);b?($(".selectionlimiterror").remove(),d.removeClass("unclickable"),d.addClass("clickable"),void 0!=c._make_selectable&&d.each(function(a,b){c._make_selectable($(".treeview",c._container))})):(d.removeClass("clickable"),d.addClass("unclickable"),$("a",d).off("click"),$("a",d).click(function(a){a.preventDefault()}))},totaraDialog_handler_treeview.prototype._make_deletable=function(a){var b=$(".deletebutton",a),c=this;b.off("click"),b.each(function(){var a=$(this).parent();a.hasClass("unremovable")||$(this).click(function(){var a=$(this).parent();return c._toggle_items(a.attr("id"),!0),a.remove(),!1})})},totaraDialog_handler_treeview.prototype._append_to_selected=function(a){var b=a.closest("span").clone(),c=$(".selected",this._container);if($("#"+b.attr("id"),c).length<1){var d=$("<div></div>").append(b),e=d.find("span").first().data().displaystring;e&&d.find("a").first().text(e),c.append(d),$("a",d).click(function(a){a.preventDefault()}),c.scrollTop(c.children().slice(-1).position().top),this._make_deletable(c)}},totaraDialog_handler_treeview_multiselect=function(){},totaraDialog_handler_treeview_multiselect.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_treeview_multiselect.prototype.every_load=function(){this._make_selectable($(".treeview",this._container)),this._make_deletable($(".selected",this._container))},totaraDialog_handler_treeview_multiselect.prototype._make_selectable=function(a){var b=$("span.clickable",a),c=this;$("span.clickable a",a).off();b.off("click"),b.on("click",function(){if("undefined"!=typeof c.selectionlimit){var a=$(".selected > div > span",c._container);if(c._get_ids(a).length>=c.selectionlimit)return void($(".selectionlimiterror").length||require(["core/templates","core/str"],function(a,b){b.get_string("selectionlimited","totara_core",c.selectionlimit).then(function(b){var d={announce:1,closebutton:0,extraclasses:"selectionlimiterror",message:b};a.render("core/notification_error",d).then(function(a){c._container.before(a)})})}))}var b=$(this);return c._append_to_selected(b),c._toggle_items(b.attr("id"),!1),!1})},totaraDialog_handler_treeview_multiselect.prototype.set_selection_limit=function(a){this.selectionlimit=a},totaraDialog_handler_treeview_multiselect.prototype._handle_update_hierarchy=function(a){this._make_selectable(a)},totaraDialog_handler_treeview_multiselect_rb_filter=function(){},totaraDialog_handler_treeview_multiselect_rb_filter.prototype=new totaraDialog_handler_treeview_multiselect,totaraDialog_handler_treeview_multiselect_rb_filter.prototype.first_load=function(){var a=this._title,b=$(".list-"+a),c=this,d="";$(".multiselect-selected-item",b).each(function(a,b){var e=$(this).data("id"),f=$(this).text();d+='<div class="treeview-selected-item"><span id="item_'+e+'"><a href="#">'+f+'</a><span class="deletebutton">'+M.util.get_string("delete","totara_core")+"</span></span></div>",c._toggle_items("item_"+e,!1)});var e=$(".selected",this._container);e.append(d),totaraDialog_handler_treeview_multiselect.prototype.first_load.call(this)},totaraDialog_handler_treeview_multiselect_rb_filter.prototype._update=function(a){var b=this._title,c=$("input[name="+b+"]"),d=c.val(),e=d?d.split(","):[];$("#"+b+" .selected .clickable").each(function(a,b){e.push($(this).attr("id").split("_")[1])});var f=e.join(",");c.val(f),this._dialog.hide();var g=$("div.list-"+this._title);g.replaceWith(a),$(".totara-noscript",$("div.list-"+this._title)).hide()},totaraDialog_handler_treeview_singleselect=function(a,b,c){this.value_element_name=a,this.text_element_id=b,"undefined"!=c?this.dualpane=c:this.dualpane=!1},totaraDialog_handler_treeview_singleselect.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_treeview_singleselect.prototype._handle_update_hierarchy=function(a){this._make_selectable(a)},totaraDialog_handler_treeview_singleselect.prototype.setup_delete=function(){this.deletable=!0;var a=$("#"+this.text_element_id),b=$('input[name="'+this.value_element_name+'"]'),c=$('<a href="#" class="dialog-singleselect-deletable"></a>'),d=this;c.click(function(c){c.preventDefault(),b.val(""),a.removeClass("nonempty"),a.empty(),d.setup_delete()}),require(["core/templates"],function(a){a.renderIcon("delete",M.util.get_string("delete","totara_core")).done(function(a){c.html(a)})}),a.hasClass("nonempty")&&a.text().length>0&&a.append(c)},totaraDialog_handler_treeview_singleselect.prototype.first_load=function(){totaraDialog_handler_treeview.prototype.first_load.call(this),this._set_current_selected()},totaraDialog_handler_treeview_singleselect.prototype.every_load=function(){this._make_selectable($(".treeview",this._container))},totaraDialog_handler_treeview_singleselect.prototype._set_current_selected=function(){var a=$('input[name="'+this.value_element_name+'"]').val(),b=$("#"+this.text_element_id).clone();$(".dialog-singleselect-deletable",b).remove(),b=b.text();var c=60;a&&b||(a=0,b="None"),label_length=$("#treeview_currently_selected_span_"+this._title+" label").html().length,b.length+label_length>c&&(b=b.substring(0,c-label_length)+"..."),$("#treeview_selected_text_"+this._title).text(b),$("#treeview_selected_val_"+this._title).val(a),0!=a&&($("#treeview_currently_selected_span_"+this._title).css("display","inline"),this._toggle_items("item_"+a,!1))},totaraDialog_handler_treeview_singleselect.prototype._save=function(){dialog=this;var a=$("#treeview_selected_val_"+this._title).val();if("0"===a)return M.str.hasOwnProperty("totara_core")&&M.str.totara_core.hasOwnProperty("error:"+this._title+"notselected")?alert(M.util.get_string("error:"+this._title+"notselected","totara_core")):require(["core/str"],function(a){a.get_string("error:itemnotselected","totara_core").done(function(a){alert(a)})}),!1;var b=$(".treeview span.unclickable#item_"+a+" a",dialog._container).html();this.value_element_name&&$('input[name="'+this.value_element_name+'"]').val(a),this.text_element_id&&(b?($("#"+this.text_element_id).html(b),$("#"+this.text_element_id).addClass("nonempty")):$("#"+this.text_element_id).removeClass("nonempty"),this.deletable&&this.setup_delete()),this.external_function&&this.external_function(),this._dialog.hide()},totaraDialog_handler_treeview_singleselect.prototype._make_selectable=function(a){var b=$("span.clickable",a),c=this;$("span.clickable a",a).off();return b.off("click"),this.dualpane?void b.click(function(){var a=$(this),b=$("#treeview_selected_val_"+c._title).val();c._toggle_items("item_"+b,!0),c._toggle_items($(this).attr("id"),!1);var d=a.attr("id").split("_");return d=d[d.length-1],a.attr("id",d),void 0!=c.handle_click&&c.handle_click($(this)),!1}):(b.click(function(){var b=$(this),d=b.clone(),e=60,f=$("#treeview_selected_val_"+c._title).val();c._toggle_items($(this).attr("id"),!1),label_length=$("#treeview_currently_selected_span_"+c._title+" label").html().length,c.get_selected_title?selected_title=c.get_selected_title(d):$("a",d).html().length+label_length>e?selected_title=$("a",d).html().substring(0,e-label_length)+"...":selected_title=$("a",d).html(),$("#treeview_selected_text_"+c._title).html(selected_title);var g=d.attr("id").split("_")[1];return $("#treeview_selected_val_"+c._title).val(g),$("#treeview_currently_selected_span_"+c._title).css("display","inline"),c._toggle_items("item_"+f,!0),c._make_selectable(a),!1}),void c._toggle_items("item_"+$("#treeview_selected_val_"+c._title).val(),!1))},totaraDialog_handler_skeletalTreeview=function(){},totaraDialog_handler_skeletalTreeview.prototype=new totaraDialog_handler_treeview,totaraDialog_handler_skeletalTreeview.prototype.every_load=function(){$(".treeview",this._container).treeview({prerendered:!0});var a=this;$(".simpleframeworkpicker",this._container).off("change"),$(".simpleframeworkpicker",this._container).change(function(){a._set_framework()}),$(".planselector",this._container).off("change"),$(".planselector",this._container).change(function(){a._set_plan()}),this._make_hierarchy($(".treeview",this._container)),this._make_deletable($(".selected",this._container))},totaraDialog_handler_skeletalTreeview.prototype._make_hierarchy=function(a){var b=this;$("span.folder, div.hitarea",a).click(function(){var a=$(this).parent();if(0===$("li:visible",$(a)).length)return!1;if(0===$("> ul > li.loading",a).length)return!1;var c=a.attr("id").substr(10);return b._handle_hierarchy_expand(c),!1})},totaraDialog_handler_skeletalTreeview.prototype._update_hierarchy=function(a,b){var c=a,d=$(".treeview li#item_list_"+b+" ul:first",this._container);$("> li.loading",d).remove(),$(".treeview",this._container).treeview({add:d.append($(c))});var e=this;e._make_selectable(d,!1)},totaraDialog_handler_skeletalTreeview.prototype._make_selectable=function(a,b){var c=this;b&&b.addClass("clickable"),void 0!=c._handle_course_click?$("span.clickable",a).click(function(){var a=$(this).parent(),b=a.attr("id").substr(7);c._handle_course_click(b)}):($("span.clickable",a).parent().mouseenter(function(){$(".addbutton",this._container).css("display","none"),$(this).find(".addbutton").css("display","inline")}),$("span.clickable",a).parent().mouseleave(function(){$(this).find(".addbutton").css("display","none")}),$("span.clickable",a).find(".list-item-action").click(function(){c._append_to_selected($(this)),$(this).parents("span:first").attr("class","unclickable"),$(this).html("")}))},totaraDialog_handler_form=function(){},totaraDialog_handler_form.prototype=new totaraDialog_handler,totaraDialog_handler_form.prototype.every_load=function(){var a=this,b=$("form",this._container);b.off("submit"),b.on("submit",function(b){b.preventDefault(),a._dialog.showLoading();var c=$(this).attr("action"),d=$(this).attr("method"),e=$(this).serialize();a._dialog._request(c,{object:a,method:"_updatePage"},d,e)})},totaraDialog_handler_form.prototype.submit=function(){var a=$("form",this._container).first();a.submit()},totaraDialog_handler_form.prototype._updatePage=function(a){var b=$(a);b.each(function(){var a=$(this).attr("id");a&&$("body #"+a).replaceWith($(this))}),this._dialog.hide()},totaraDialog_handler_selectable=function(a){this.selected=a},totaraDialog_handler_selectable.prototype=new totaraDialog_handler,totaraDialog_handler_selectable.prototype.first_load=function(){$("#icon-selectable").selectable({filter:"li",multiple:!1}),this._set_selected()},totaraDialog_handler_selectable.prototype.every_load=function(){totaraDialog_handler_selectable.prototype.first_load.call(this)},totaraDialog_handler_selectable.prototype._updatePage=function(a){var b="undefined"==typeof this._dialog.suffix?"":this._dialog.suffix;""===b?$("input[name=icon]").val(a.id):$("#icon"+b).val(a.id),$("#icon_preview"+b).attr("src",a.src),$("#icon_preview"+b).attr("title",a.id.replace(/-|_/g," ").toTitleCase()),this._dialog.hide()},totaraDialog_handler_selectable.prototype._set_selected=function(){$("#"+this.selected).addClass("ui-selected"),$("input[name=icon]").attr("initialvalue",this.selected)},String.prototype.toTitleCase=function(){return this.replace(/\w\S*/g,function(a){return a.charAt(0).toUpperCase()+a.substr(1).toLowerCase()})},totaraSingleSelectDialog=function(a,b,c,d,e,f,g){var h=new totaraDialog_handler_treeview_singleselect(d,e),i={};g&&h.setup_delete(),h.external_function=f,i[M.util.get_string("ok","moodle")]=function(){h._save()},i[M.util.get_string("cancel","moodle")]=function(){h._cancel()},totaraDialogs[a]=new totaraDialog(a,"show-"+a+"-dialog",{buttons:i,title:"<h2>"+b+"</h2>"},c,h)},totaraMultiSelectDialog=function(a,b,c,d){var e=new totaraDialog_handler_treeview_multiselect,f={};f[M.util.get_string("save","totara_core")]=function(){e._save(d)},f[M.util.get_string("cancel","moodle")]=function(){e._cancel()},totaraDialogs[a]=new totaraDialog(a,"show-"+a+"-dialog",{buttons:f,title:"<h2>"+b+"</h2>"},c,e)},totaraMultiSelectDialogRbFilter=function(a,b,c,d){var e=new totaraDialog_handler_treeview_multiselect_rb_filter,f="input[name="+a+"_selection_limit]";$(f)&&e.set_selection_limit($(f).val());var g={};g[M.util.get_string("save","totara_core")]=function(){e._save(d)},g[M.util.get_string("cancel","moodle")]=function(){e._cancel()},totaraDialogs[a]=new totaraDialog(a,"show-"+a+"-dialog",{buttons:g,title:"<h2>"+b+"</h2>"},c,e),$(document).on("click",".multiselect-selected-item[data-filtername="+a+"] a",function(a){a.preventDefault();var b=$(this).parents("div.multiselect-selected-item"),c=b.data("filtername"),d=b.data("id"),e=$("input[name="+c+"]"),f=e.val(),g=f.split(","),h=$.grep(g,function(a,b){return a!=d}),i=h.join(",");e.val(i),b.remove()})};for(var init in window.dialoginits)"function"==typeof window.dialoginits[init]&&window.dialoginits[init]();window.dialogsInited=!0;