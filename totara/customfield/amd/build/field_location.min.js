define(["jquery"],function(a){function b(b,c){function d(a,b){return c[a]&&"undefined"!==c[a]&&""!==c[a]?c[a]:b}this.google=b,this.clientid=d("clientid",!1),this.apikey=d("apikey",!1),this.fieldprefix=d("fieldprefix",""),this.fordisplay=d("fordisplay",!1),this.regionbias=d("regionbias",""),this.defaultzoomlevel=d("defaultzoomlevel",12),this.address="",this.location={lat:null,lng:null},this.view=null,this.map=null,this.marker=null,this.input_address=a("#id_"+this.fieldprefix+"address"),this.input_latitude=a("#"+this.fieldprefix+"latitude"),this.input_longitude=a("#"+this.fieldprefix+"longitude"),this.input_zoom=a("#"+this.fieldprefix+"zoom"),this.fieldset=null,this.fordisplay||this.wireDefinitionControls();var e=a("#"+this.fieldprefix+"room-location-view"),f=a("#"+this.fieldprefix+"location_map");if(f.length){if(!this.input_latitude.length)return void f.hide();if(this.location.lat=parseFloat(this.input_latitude.val()),!this.input_longitude.length)return void f.hide();this.location.lng=parseFloat(this.input_longitude.val()),this.fieldset=f.closest("fieldset.collapsible.collapsed"),this.fieldset.length&&(window.form_fieldset_expand=window.form_fieldset_expand||[],window.form_fieldset_expand.push({context:this,callback:this.fieldSetRefreshMap}),this.fieldset.attr("data-location-refresh-"+this.fieldprefix,"true")),this.input_zoom.length?this.location.zoom=parseInt(this.input_zoom.val()):this.location.zoom=this.defaultzoomlevel,this.input_address.length&&(this.address=this.input_address.val().trim()),e.length?"map"==e.val()?this.view=this.google.maps.MapTypeId.ROADMAP:"satellite"==e.val()?this.view=this.google.maps.MapTypeId.SATELLITE:this.view=this.google.maps.MapTypeId.HYBRID:this.view=this.google.maps.MapTypeId.ROADMAP,this.load_map()}}return b.prototype.fieldSetRefreshMap=function(b){this.map&&"true"===a(b).attr("data-location-refresh-"+this.fieldprefix)&&(a(b).attr("data-location-refresh-"+this.fieldprefix,"false"),this.google.maps.event.trigger(this.map,"resize"),this.location.lat=parseFloat(this.input_latitude.val()),this.location.lng=parseFloat(this.input_longitude.val()),this.map.panTo(this.location))},b.prototype.wireDefinitionControls=function(){var b=this,c=this.fordisplay,d=this.input_address,e=a("#id_"+this.fieldprefix+"addresslookup"),f=a('.radio_view[name="'+this.fieldprefix+'view"]'),g=a("#id_"+this.fieldprefix+"searchaddress_btn"),h=a("#id_"+this.fieldprefix+"useaddress_btn");g&&g.on("click",function(){b.address=e.val().trim(),b.geocode_address()}),e&&g&&(b.address=e.keydown(function(a){if(13===a.keyCode)return a.preventDefault(),g.click(),!1})),h&&h.on("click",function(){b.address=d.val().trim(),b.geocode_address()}),f&&f.on("change",function(){this.id.indexOf(b.fieldprefix)>-1&&(b.defaultzoomlevel=b.map.getZoom(),b.set_map_view(),b.load_map(c))})},b.prototype.set_map_view=function(){var b=this,c=a('.radio_view[name="'+this.fieldprefix+'view"]:checked');c.each(function(a,c){if(c.id.indexOf(b.fieldprefix)>-1)switch(c.value){case"hybrid":b.map.setMapTypeId(b.google.maps.MapTypeId.HYBRID),b.view=b.google.maps.MapTypeId.HYBRID;break;case"satellite":b.map.setMapTypeId(b.google.maps.MapTypeId.SATELLITE),b.view=b.google.maps.MapTypeId.SATELLITE;break;default:b.map.setMapTypeId(b.google.maps.MapTypeId.ROADMAP),b.view=b.google.maps.MapTypeId.ROADMAP}})},b.prototype.geocode_address=function(){var b=this,c=this.url_encode_address(this.address),d="https://maps.googleapis.com/maps/api/geocode/json?address="+c+"&region="+this.regionbias;M.util.js_pending("totara_customfield-location_search"),""!==c&&(this.clientid?d+="&client="+this.clientid:this.apikey&&(d+="&key="+this.apikey),a.ajax({url:d,type:"GET",success:function(c,d){"success"==d&&c.results.length>0?(b.address=c.results[0].formatted_address,b.location=c.results[0].geometry.location,b.load_map(),a("#fgroup_id_"+b.fieldprefix+"mapelements .felement .alert").hide(),M.util.js_complete("totara_customfield-location_search")):0===a("#fgroup_id_"+b.fieldprefix+"mapelements .felement .alert").length?require(["core/templates","core/str"],function(c,d){d.get_string("locationnotfound","totara_customfield").done(function(d){c.render("core/notification_error",{message:d}).done(function(c){a("#fgroup_id_"+b.fieldprefix+"mapelements .felement").prepend(c),M.util.js_complete("totara_customfield-location_search")})})}):(a("#fgroup_id_"+b.fieldprefix+"mapelements .felement .alert").show(),M.util.js_complete("totara_customfield-location_search"))},error:function(){window.console&&window.console.log&&window.console.log("Failed to load Google maps API.")}}))},b.prototype.get_zoom_level=function(){return parseInt(this.input_zoom.val())},b.prototype.load_map=function(a){if(a="undefined"!=typeof a?a:this.fordisplay,null!==this.location.lat){var b,c=this,d={center:this.location,zoomControl:!0,mapTypeControl:!1,scaleControl:!1,streetViewControl:!1,rotateControl:!1,mapTypeId:this.view,zoom:this.get_zoom_level()},e="";if(this.map=new this.google.maps.Map(document.getElementById(this.fieldprefix+"location_map"),d),a||this.set_map_view(),this.marker=new this.google.maps.Marker({position:this.location,map:this.map,draggable:!a}),this.input_latitude.val(this.location.lat),this.input_longitude.val(this.location.lng),a){if(!(null!==this.address&&this.address.length>0))return;e=this.address,b=new this.google.maps.InfoWindow({content:e}),this.marker.addListener("click",function(){b.open(c.map,c.marker)})}else this.marker.addListener("drag",function(a){c.input_latitude.val(a.latLng.lat()),c.input_longitude.val(a.latLng.lng())}),this.map.addListener("zoom_changed",function(a){c.input_zoom.val(c.map.getZoom())})}},b.prototype.url_encode_address=function(a){return encodeURI(a.replace(/\s+/g,"+"))},{init:function(a){M.util.js_pending("totara_customfield-location_init"),require(["totara_customfield/field_location_loader!"+a.mapparams],function(){new b(google,a),M.util.js_complete("totara_customfield-location_init")})}}});