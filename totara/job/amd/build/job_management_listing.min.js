define(["jquery","core/ajax","core/notification","core/str"],function(a,b,c,d){function e(b){this.items=[],this.userid=b;var c=this;this.container=a('[data-enhance="job-management-listing"][data-enhanced="false"][data-userid="'+b+'"]'),this.container&&(this.container.attr("data-enhanced","true"),this.container.find("li a.editjoblink[data-id]").each(function(){var b=a(this),d=b.data("id"),e=b.data("sortorder");c.register_item(d,e,b)}),this.container.delegate("a[data-action]","click",function(b){b.preventDefault(),b.stopPropagation();var d=a(b.currentTarget),e=d.data("action"),f=d.data("id");"up"===e?c.move_item_up(f):"down"===e?c.move_item_down(f):"delete"===e&&c.confirm_delete(f)}))}return e.prototype.userid=null,e.prototype.items=[],e.prototype.container=null,e.prototype.register_item=function(b,c,d){a(d).parent("li").find("a[data-action]").each(function(){a(this).attr("data-id",b)}),this.items.push({id:b,sortorder:c})},e.prototype.confirm_delete=function(b){var e=this.container.find('a.editjoblink[data-id="'+b+'"]'),f=this,g=[],h=a.ajax({url:M.cfg.wwwroot+"/totara/job/dialog/get_deletion_notification.php",type:"GET",data:{sesskey:M.cfg.sesskey,userid:this.userid,jobassignmentid:b,jobassignmenttext:e.text()}});h.done(function(a){g.jobassignment=e.text();var h=d.get_strings([{key:"deletejobassignment",component:"totara_job",param:null,lang:null},{key:"confirmdeletejobassignment",component:"totara_job",param:g,lang:null},{key:"yesdelete",component:"totara_core",param:null,lang:null},{key:"cancel",component:"core",param:null,lang:null}]);h.done(function(d){a&&(d[1]=a),d.push(function(){M.util.js_pending("totara_job-delete");var a=f.delete_job_assignment(b);a.done(function(){M.util.js_complete("totara_job-delete")})}),c.confirm.apply(c.confirm,d)})}).fail(c.exception)},e.prototype.delete_job_assignment=function(c){var d=[{methodname:"totara_job_external_delete_job_assignment",args:{userid:this.userid,jobassignmentid:c}}],e=a.Deferred(),f=this,g=b.call(d,!0,!0);return a.when.apply(null,g).done(function(){f.update_list(arguments[0]),e.resolve()}).fail(function(a){e.reject(a)}),e.promise()},e.prototype.move_item_up=function(b){var c=0,d=0,e=!1,f=this.get_item_by_id(b),g=this.container.find("ul");if(f===!1)return!1;for(c in this.items)this.items.hasOwnProperty(c)&&this.items[c].sortorder>=d&&this.items[c].sortorder<f.sortorder&&(e=this.items[c],d=this.items[c].sortorder);if(!e)return!1;M.util.js_pending("totara_job-move_item_up");var h=this.switch_items(e,f);h.done(function(){var b=a(g.find('a.editjoblink[data-id="'+f.id+'"]').parents("li")[0]);b.fadeOut(50,function(){b.css({backgroundColor:"#fefdb2"})}).fadeIn(500,function(){b.css({backgroundColor:"initial"})}),M.util.js_complete("totara_job-move_item_up")})},e.prototype.move_item_down=function(b){var c=0,d=2147483646,e=!1,f=this.get_item_by_id(b),g=this.container.find("ul");if(f===!1)return!1;for(c in this.items)this.items.hasOwnProperty(c)&&this.items[c].sortorder<=d&&this.items[c].sortorder>f.sortorder&&(e=this.items[c],d=this.items[c].sortorder);if(!e)return!1;M.util.js_pending("totara_job-move_item_down");var h=this.switch_items(e,f);h.done(function(){var b=a(g.find('a.editjoblink[data-id="'+f.id+'"]').parents("li")[0]);b.fadeOut(50,function(){b.css({backgroundColor:"#fefdb2"})}).fadeIn(500,function(){b.css({backgroundColor:"initial"})}),M.util.js_complete("totara_job-move_item_down")})},e.prototype.get_item_by_id=function(a){var b;for(b in this.items)if(this.items.hasOwnProperty(b)&&this.items[b].id==a)return this.items[b];return!1},e.prototype.switch_items=function(c,d){var e,f=!1,g=d.sortorder,h=!1,i=c.sortorder,j=[],k=a.Deferred(),l=this;for(e in this.items)this.items.hasOwnProperty(e)&&(this.items[e].id===c.id&&(this.items[e].sortorder=g,f=e),this.items[e].id===d.id&&(this.items[e].sortorder=i,h=e),j.push({jobassignid:this.items[e].id,sortorder:this.items[e].sortorder}));if(!f&&!h)return k.reject(),k.promise();var m=[{methodname:"totara_job_external_resort_job_assignments",args:{userid:this.userid,sort:j}}],n=b.call(m,!0,!0);return a.when.apply(null,n).done(function(){l.update_list(arguments[0]),k.resolve()}).fail(function(a){k.reject(a)}),k.promise()},e.prototype.update_list=function(a){var b,c,d,e,f,g,h,i=[],j=this.container.find("ul");for(b in a)if(a.hasOwnProperty(b)){d=a[b].jobassignid,e=a[b].sortorder,h=!1;for(c in this.items)if(this.items.hasOwnProperty(c)&&this.items[c].id==d){this.items[c].sortorder=e,h=!0;break}if(!h)continue;f=this.container.find('a[data-id="'+d+'"]'),f.attr("data-sortorder",e),g=f.parent("li"),i.push("<li>"+g.html()+"</li>")}j.empty(),j.append.apply(j,i),this.container.attr("data-jobcount",i.length)},{init:function(a){return new e(a)}}});