define(["core/ajax","core/templates","core/config","core/notification","core/str"],function(a,b,c,d,e){function f(a){var b=this;this.node=a,this.assignments=[],this.categories=[],this.recent=!1,this.searchTerm="",this.strings={},this.dialog=null,this.baseURL=c.wwwroot+"/totara/program/assignment/",this.programId=parseInt(a.getAttribute("data-totara_program-id"),10),this.canupdate="1"===a.getAttribute("data-totara_program-canupdate"),this.typeid=0,this.actualduedatesdialog=null,this.config={COMPLETION_EVENT_ENROLLMENT_DATE:"6",COMPLETION_EVENT_FIRST_LOGIN:"1",COMPLETION_EVENT_NONE:"0",COMPLETION_TIME_NOT_SET:"-1",CONDENSED_LIMIT:5},this.addOptions=[],M.util.js_pending("totara_program--assignments-strings"),this.stringsPromise=new Promise(function(a){var d=[{component:"totara_program",key:"ok"},{component:"totara_program",key:"remove"},{component:"totara_program",key:"cancel"},{component:"totara_program",key:"setduedate"},{component:"totara_program",key:"completioncriteria"},{component:"totara_program",key:"addorganisationstoprogram"},{component:"totara_program",key:"addpositionstoprogram"},{component:"totara_program",key:"addcohortstoprogram"},{component:"totara_program",key:"addindividualstoprogram"},{component:"totara_program",key:"addmanagerstoprogram"}];e.get_strings(d).done(function(d){b.strings.ok=d[0],b.strings.remove=d[1],b.strings.cancel=d[2],b.strings.setduedate=d[3],b.strings.completioncriteria=d[4],b.addOptions[1]={name:"organisations",url:"find_hierarchy.php?type=organisation",text:d[5],notificationKey:"assignmentsaddedorgainisation"},b.addOptions[2]={name:"positions",url:"find_hierarchy.php?type=position",text:d[6],notificationKey:"assignmentsaddedposition"},b.addOptions[3]={name:"cohorts",url:"find_cohort.php?sesskey="+c.sesskey,text:d[7],notificationKey:"assignmentsaddedaudience"},b.addOptions[5]={name:"individuals",url:"find_individual.php?",text:d[8],notificationKey:"assignmentsaddedindividual"},b.addOptions[6]={name:"managers",url:"find_manager_hierarchy.php?",text:d[9],notificationKey:"assignmentsaddedposition"},M.util.js_complete("totara_program--assignments-strings"),a()})}),M.util.js_pending("totara_program--assignments-dialogs"),this.dialogPromise=new Promise(function(a){window.dialogsInited?(a(),M.util.js_complete("totara_program--assignments-dialogs")):(window.dialoginits=window.dialoginits||[],window.dialoginits.push(function(){a(),M.util.js_complete("totara_program--assignments-dialogs")}))})}function g(a){return new Promise(function(b){var c=new f(a);c.events(),b(c)})}return f.prototype.events=function(){var a=this;this.node.addEventListener("totara_core/select_search_text:add",function(b){a.searchTerm=b.detail.val}),this.node.addEventListener("totara_core/select_search_text:remove",function(b){a.searchTerm=b.detail.val}),this.node.addEventListener("totara_core/select_search_text:changed",a.filter.bind(a)),this.node.addEventListener("totara_core/select_region_panel:add",function(b){switch(b.detail.key){case"recent":a.recent=!0;break;case"type":a.categories=b.detail.groupValues}}),this.node.addEventListener("totara_core/select_region_panel:remove",function(b){switch(b.detail.key){case"recent":a.recent=!1;break;case"type":a.categories=b.detail.groupValues}}),this.node.addEventListener("totara_core/select_region_panel:changed",a.filter.bind(a)),this.node.addEventListener("change",function(b){if("totara_program-assignment--add-users"===b.target.id&&(b.preventDefault(),a.startAdd(b.target.value)),"update-below"===b.target.getAttribute("data-totara_program__assignments--action")){b.preventDefault();var c=b.target.closest("[data-totara_program__assignment-id]"),d=c.getAttribute("data-totara_program__assignment-id"),e=0;switch(c.classList.add("totara_program__assignments__loading"),b.target.tagName.toLowerCase()){case"input":e=b.target.checked?1:0;break;case"select":e=b.target.value}a.updateBelow(d,e)}}),this.node.addEventListener("click",function(b){var c=b.target.closest("[data-totara_program__assignments--action]");if(null!==c){var d=b.target.closest("[data-totara_program__assignment-id]"),e=parseInt(d.getAttribute("data-totara_program__assignment-id"),10);switch(c.getAttribute("data-totara_program__assignments--action")){case"delete":b.preventDefault(),a.deleteAssignment(e);break;case"change-due-date":b.preventDefault(),a.startChangeDuedate(e);break;case"remove-due-date":b.preventDefault(),a.removeDueDate(e);break;case"view-actual-dates":b.preventDefault(),a.viewActualDates(e)}}}),document.addEventListener("click",function(b){var c=b.target.closest(".moodle-dialogue-content .embeddedshortname_program_assignment_duedates a, .moodle-dialogue-content .embeddedshortname_cert_assignment_duedates a");c&&c.getAttribute("href")&&(b.preventDefault(),M.util.js_pending("totara_program--assignments-view-duedates-change"),fetch(c.getAttribute("href"),{credentials:"same-origin",method:"get"}).then(function(a){return a.text()}).then(function(b){a.actualduedatesdialog.set("bodyContent",b),M.util.js_complete("totara_program--assignments-view-duedates-change")})["catch"](d.exception))})},f.prototype.deleteAssignment=function(c){var f=this,g=this.node.querySelector('[data-totara_program__assignment-id="'+c+'"]'),h=g.querySelector(".totara_program__assignments__row-name").innerText;g.classList.add("totara_program__assignments__loading"),M.util.js_pending("totara_program--assignments-delete-assignment");var i=new Promise(function(a){e.get_string("removeassignmentconfirmation","totara_program").done(a)});Promise.all([i,this.stringsPromise]).then(function(i){M.util.js_complete("totara_program--assignments-delete-assignment"),d.confirm("",i[0],f.strings.remove,f.strings.cancel,function(){a.call([{methodname:"totara_program_assignment_delete",args:{assignment_id:c}}])[0].then(function(a){a.success&&(g.remove(),f._clearNotifications(),e.get_string("removedfromprogram","totara_program",h).done(function(a){d.addNotification({message:a,type:"success",closebutton:!0,announce:!0})})),f._updateStatus(a.status),0===f.node.querySelectorAll(".totara_program__assignments__results__table tbody tr").length&&b.render("totara_program/assignment__no-results").done(function(a,c){f.node.querySelector(".totara_program__assignments__results").innerHTML=a,b.runTemplateJS(c)})}).fail(d.exception)},function(){g.classList.remove("totara_program__assignments__loading")})})["catch"](d.exception)},f.prototype.filter=function(){var c=this,e={categories:this.categories,term:this.searchTerm,recent:this.recent,program_id:this.programId},f=this.node.querySelector(".totara_program__assignments__results");f.classList.add("totara_program__assignments__loading"),a.call([{methodname:"totara_program_assignment_filter",args:e}])[0].then(function(a){return a.toomany?b.render("totara_program/assignment__too-many"):0===a.count?b.render("totara_program/assignment__no-results"):(a.canupdate=c.canupdate,b.render("totara_program/assignment_table",a))}).then(function(a,d){c.categories===e.categories&&c.term===e.searchTerm&&c.recent===e.recent&&(f.innerHTML=a,b.runTemplateJS(d),f.classList.remove("totara_program__assignments__loading"))}).fail(d.exception)},f.prototype.startChangeDuedate=function(b){var c=this,f=new Promise(function(a){var b=[{component:"totara_core",key:"datepickerlongyeardisplayformat"},{component:"totara_program",key:"chooseitem"},{component:"moodle",key:"none"},{component:"totara_hierarchy",key:"selected"}];e.get_strings(b).done(a)});M.util.js_pending("totara_program--assignments-change-duedates"),Promise.all([f,this.stringsPromise,this.dialogPromise]).then(function(f){var g={dateFormat:f[0][0],chooseitem:f[0][1],none:f[0][2]},h=function(){var a=new totaraDialog_handler_treeview_singleselect("instance","instancetitle"),b=this,d={};this.save=function(){document.getElementById("instance").value=document.getElementById("treeview_selected_val_"+this.handler._title).value,document.getElementById("instancetitle").innerHTML=document.getElementById("treeview_selected_text_"+this.handler._title).innerText,b.hide()},this.clear=function(){document.getElementById("instance").value=0,document.getElementById("instancetitle").value=""},d[c.strings.ok]=b.save.bind(b),d[c.strings.cancel]=a._cancel.bind(a);var e=' <span id="treeview_currently_selected_span_completion-event-dialog" style="display:none">(<label for="treeview_selected_text_completion-event-dialog">'+f[0][3]+':&nbsp</label><em><span id="treeview_selected_text_completion-event-dialog"></span></em>)</span><input type="hidden" id="treeview_selected_val_completion-event-dialog" name="treeview_selected_val_completion-event-dialog" value=""/>';totaraDialog.call(this,"completion-event-dialog","unused2",{buttons:d,title:"<h2>"+g.chooseitem+e+"</h2>"},"unused2",a)};totaraDialogs.completionevent=new h;var i=function(){};i.prototype=new totaraDialog_handler,i.prototype.first_load=function(){var f=this._dialog.dialog[0],h=this;M.totara_core.build_datepicker(null,'input[name="completiontime"]',g.dateFormat),f.querySelector(".fixeddate").addEventListener("click",function(){var g=f.querySelector(".completiontime").value,i=f.querySelector(".completiontimehour").value,j=f.querySelector(".completiontimeminute").value;M.util.js_pending("totara_program--assignments-change-duedates-fixed"),new Promise(function(a,b){e.get_string("datepickerlongyearregexjs","totara_core").then(function(c){var d=new RegExp(c);d.test(g)===!1?b():a()})}).then(function(){var d={assignment_id:b,duedate:g,hour:i,minute:j};a.call([{methodname:"totara_program_assignment_set_fixed_due_date",args:d}])[0].then(function(a){c._changeDuedate(b,a),h._dialog.hide(),M.util.js_complete("totara_program--assignments-change-duedates-fixed")})})["catch"](function(){e.get_string("datepickerlongyearplaceholder","totara_core").then(function(a){return M.util.js_complete("totara_program--assignments-change-duedates-fixed"),e.get_string("pleaseentervaliddate","totara_program",a)}).then(function(a){d.alert("",a,c.strings.ok)})})}),f.querySelector(".relativeeventtime").addEventListener("click",function(){var g=f.querySelector("#timeamount").value,i=f.querySelector("#eventtype").value,j=""===f.querySelector("#instance").value?0:f.querySelector("#instance").value,k=/^\d{1,3}$/;if(k.test(g)===!1)e.get_string("pleaseentervalidunit","totara_program").done(function(a){d.alert("",a,c.strings.ok)});else if(0==j&&i!=c.config.COMPLETION_EVENT_FIRST_LOGIN&&i!=c.config.COMPLETION_EVENT_ENROLLMENT_DATE)e.get_string("pleasepickaninstance","totara_program").done(function(a){d.alert("",a,c.strings.ok)});else{var l={assignment_id:b,num:f.querySelector("#timeamount").value,period:f.querySelector("#timeperiod").value,event:f.querySelector("#eventtype").value,eventinstanceid:j};a.call([{methodname:"totara_program_assignment_set_relative_due_date",args:l}])[0].then(function(a){c._changeDuedate(b,a),h._dialog.hide()}).fail(d.exception)}})},i.prototype.every_load=function(){var a=this._dialog.dialog[0],b=a.querySelector('[name="event"]'),c=a.querySelector('[name="eventinstancename"]');b&&(a.querySelector('[name="eventtype"]').value=b.value),c&&(a.querySelector("#instancetitle").innerText=c.value)};var j={};j[c.strings.cancel]=function(){c.dialog.hide()};var k="set_completion.php?programid="+c.programId+"&assignmentid="+b;c.dialog=new totaraDialog("completion-dialog",null,{buttons:j,title:"<h2>"+c.strings.completioncriteria+"</h2>"},c.baseURL+k,new i),c.dialog.open(),document.getElementById("completion-dialog").style.height="175px",M.util.js_complete("totara_program--assignments-change-duedates")})["catch"](d.exception)},f.prototype._changeDuedate=function(a,c){var d=this,e=this.node.querySelector('[data-totara_program__assignment-id="'+a+'"]'),f={canupdate:this.canupdate,duedate:c.duedate,duedateupdatable:c.duedateupdatable},g={actualduedate:c.actualduedate};this._updateStatus(c.status),e.classList.add("totara_program__assignments__loading");var h=b.render("totara_program/assignment__due_date",f).then(function(a){e.querySelector(".totara_program__assignments__row-duedate").innerHTML=a});b.render("totara_program/assignment__actual_date",g).then(function(a){return e.querySelector(".totara_program__assignments__row-actual-duedate").innerHTML=a,h}).then(function(){e.classList.remove("totara_program__assignments__loading")}),d.updateSuccess(a)},f.prototype.removeDueDate=function(b){var c=this;a.call([{methodname:"totara_program_assignment_remove_due_date",args:{assignment_id:b}}])[0].then(function(a){c._changeDuedate(b,a)})},f.prototype.viewActualDates=function(a){var b=this,e=c.wwwroot+"/totara/program/assignment/duedates_report.php?programid="+b.programId+"&assignmentid="+a;M.util.js_pending("totara_program--assignments-view-duedates"),fetch(e,{credentials:"same-origin",method:"get"}).then(function(a){return a.text()}).then(function(a){b.actualduedatesdialog&&(b.actualduedatesdialog.destroy(),b.actualduedatesdialog=null),b.actualduedatesdialog=new M.core.dialogue({headerContent:null,bodyContent:a,width:900,centered:!0,modal:!0,render:!0}).show(),M.util.js_complete("totara_program--assignments-view-duedates")})["catch"](d.exception)},f.prototype.startAdd=function(a){var b=this;""!==a&&(this.typeid=a,M.util.js_pending("totara_program--assignments-addItems"),Promise.all([this.stringsPromise,this.dialogPromise]).then(function(){var c={};c[b.strings.ok]=function(){b.addAssignments()},c[b.strings.cancel]=function(){b.dialog.hide()};var d=new totaraDialog_handler_treeview_multiselect,e=b.addOptions[a].url+"&programid="+b.programId;b.dialog=new totaraDialog("add-assignment-dialog-"+a,null,{buttons:c,title:"<h2>"+b.addOptions[a].text+"</h2>"},b.baseURL+e,d),b.dialog.open(),M.util.js_complete("totara_program--assignments-addItems"),b.node.querySelector("#totara_program-assignment--add-users").value=""}))},f.prototype.addAssignments=function(){for(var c=this.dialog.handler._container.get(0).querySelectorAll(".selected > div > span.clickable"),f=[],g=this,h=0;h<c.length;h++){var i,j=c[h];j.getAttribute("data-jaid")?i=parseInt(j.getAttribute("data-jaid"),10):(i=j.id.split("_"),i=i[i.length-1],i=parseInt(i,10)),f.indexOf(i)===-1&&f.push(i)}f.length>0?(M.util.js_pending("totara_program--assignments-addingItems"),g.dialog.showLoading(),new Promise(function(b,c){a.call([{methodname:"totara_program_assignment_create",args:{programid:g.programId,typeid:g.typeid,items:f}}])[0].done(b).fail(c)}).then(function(a){var c=g._updateStatus(a.status),f=new Promise(function(b){g._clearNotifications(),a.items.length<g.config.CONDENSED_LIMIT?a.items.forEach(function(a){e.get_string("assignmentadded","totara_program",a.name).done(function(a){d.addNotification({message:a,type:"success",closebutton:!0,announce:!0}),b()})}):e.get_string(g.addOptions[g.typeid].notificationKey,"totara_program",a.items.length).done(function(a){d.addNotification({message:a,type:"success",closebutton:!0,announce:!0}),b()})}),h=new Promise(function(c,d){var e=a.items.filter(function(a){var b,c=0===g.categories.length;return(!g.searchTerm||a.name.toLowerCase().indexOf(g.searchTerm.toLowerCase())!==-1)&&(b=g.categories.some(function(b){return parseInt(b,10)===a.type_id}),c||b)});if(0===e.length)return void c();if(g.node.getElementsByClassName("totara_program__assignments__results-too-many").length>0)return void c();var f=g.node.querySelectorAll("[data-totara_program__assignment]");if(e.length+f.length>100)return void b.render("totara_program/assignment__too-many").done(function(a,d){g.node.querySelector(".totara_program__assignments__results").innerHTML=a,b.runTemplateJS(d),c()});if(g.node.getElementsByClassName("totara_program__assignments__results-no-results").length>0){var h={items:e,canupdate:g.canupdate};b.render("totara_program/assignment_table",h).done(function(a,d){g.node.querySelector(".totara_program__assignments__results").innerHTML=a,b.runTemplateJS(d),c()})}else{var i=e.map(function(a){return new Promise(function(c){a.canupdate=g.canupdate,b.render("totara_program/assignment__table__row",a).done(c)})});Promise.all(i).then(function(a){var b="";a.forEach(function(a){b+=a}),g.node.querySelector(".totara_program__assignments__results__table tbody").insertAdjacentHTML("beforeend",b),c()})["catch"](d)}});return Promise.all([c,f,h])}).then(function(){g.dialog.hide(),M.util.js_complete("totara_program--assignments-addingItems")})["catch"](d.exception)):this.dialog.hide()},f.prototype.updateBelow=function(b,c){var e=this;a.call([{methodname:"totara_program_assignment_set_include_children",args:{assignmentid:b,value:c}}])[0].done(function(a){var c=e.node.querySelector('[data-totara_program__assignment-id="'+b+'"]');e._updateStatus(a.status),e.updateSuccess(b),c.querySelector("[data-totara_program__assignments--learnercount]").innerHTML=a.numusers,c.classList.remove("totara_program__assignments__loading")}).fail(d.exception)},f.prototype.updateSuccess=function(a){var b='[data-totara_program__assignment-id="'+a+'"] .totara_program__assignments__row-name',c=this.node.querySelector(b).textContent;this._clearNotifications(),e.get_string("individualassignmentupdated","totara_program",c).done(function(a){d.addNotification({message:a,type:"success",closebutton:!0,announce:!0})})},f.prototype._updateStatus=function(a){var d=a.exception_count,f=document.querySelector("#program-assignments .tabtree li:last-child"),g=new Promise(function(a){e.get_string("exceptions","totara_program",d).done(function(b){d===parseInt(f.getAttribute("data-totara_program-exception_count"),10)&&(f.querySelector("a").innerText=b),a()})}),h={message:a.status_string,extraclasses:"notifynotice",announce:!0,closebutton:!1},i=new Promise(function(c){b.render("core/notification_"+a.state,h).done(function(a,d){document.querySelector("[data-totara_program--notification]").innerHTML=a,b.runTemplateJS(d),c()})});return f.setAttribute("data-totara_program-exception_count",d),d>0?(f.classList.remove("disabled"),f.querySelector("a").setAttribute("href",c.wwwroot+"/totara/program/exceptions.php?id="+this.programId)):(f.classList.add("disabled"),f.querySelector("a").removeAttribute("href")),Promise.all([g,i])},f.prototype._clearNotifications=function(){document.getElementById("user-notifications").innerHTML=""},{init:g}});