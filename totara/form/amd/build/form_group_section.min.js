define(["jquery","totara_form/form","core/str","core/templates"],function(a,b,c,d){function e(a,c,d){return this instanceof e?(b.Group.call(this,a,c,d),this.fieldset=null,this.legend=null,this.input=null,void(this.link=null)):new e(a,c,d)}return e.prototype=Object.create(b.Group.prototype),e.prototype.constructor=e,e.prototype.toString=function(){return"[object SectionGroup]"},e.prototype.init=function(b){if(this.fieldset=a("#"+this.id),this.legend=a("#"+this.id+" legend.tf_section_legend"),this.input=a("#"+this.id+" input.tf_section_collapsible"),!this.fieldset.hasClass("collapsed")&&!this.fieldset.hasClass("collapsible"))return void b();var c=this;this.fieldset.hasClass("collapsed")?(this.legend.html('<a href="#" role="button" aria-expanded="false">'+this.legend.html()+"</a>"),d.renderIcon("collapsed").done(function(a){c.fieldset.hasClass("collapsed")&&(c.legend.find(".flex-icon").remove(),c.legend.prepend(a))})):(this.legend.html('<a href="#" role="button" aria-expanded="true">'+this.legend.html()+"</a>"),d.renderIcon("expanded").done(function(a){c.fieldset.hasClass("collapsible")&&(c.legend.find(".flex-icon").remove(),c.legend.prepend(a))})),this.link=a("#"+this.id+" legend.tf_section_legend a"),this.link.click(a.proxy(this.toggleCollapsed,this)),e.instances.push(this),e.instancecount++,2===e.instancecount&&e.addExpandAll(this.getForm()),b()},e.prototype.toggleCollapsed=function(a){a.preventDefault(),this.fieldset.hasClass("collapsed")?this.expand():this.collapse()},e.prototype.expand=function(){b.debug("Expanding section "+this.legend.text(),this,b.LOGLEVEL.debug),this.fieldset.removeClass("collapsed"),this.fieldset.addClass("collapsible"),this.link.attr("aria-expanded","true"),this.input.val(1);var a=this;d.renderIcon("expanded").done(function(b){a.fieldset.hasClass("collapsible")&&(a.legend.find(".flex-icon").remove(),a.legend.prepend(b))})},e.prototype.collapse=function(){b.debug("Collapsing section "+this.legend.text(),this,b.LOGLEVEL.debug),this.fieldset.addClass("collapsed"),this.fieldset.removeClass("collapsible"),this.link.attr("aria-expanded","false"),this.input.val(0);var a=this;d.renderIcon("collapsed").done(function(b){a.fieldset.hasClass("collapsed")&&(a.legend.find(".flex-icon").remove(),a.legend.prepend(b))})},e.getValue=function(){return null},e.instancecount=0,e.instances=[],e.expandallcontrol=null,e.addExpandAll=function(f){b.debug("Adding expand/collapse all for sections",this,b.LOGLEVEL.info);var g='<div class="collapsible-actions form-section-expandall-control">';g+='<a href="#" class="collapseexpand" role="button" aria-controls="">&nbsp;-&nbsp;</a>',g+="</div>",f.form.prepend(g),e.expandallcontrol=a(".form-section-expandall-control"),a.when(c.get_string("expandall"),d.renderIcon("collapsed")).done(function(a,b){e.expandallcontrol.find("a").html(b+a)}),e.expandallcontrol.click(a.proxy(this.toggleAll,this)),e.expandallcontrol.data("state","expand")},e.toggleAll=function(b){b.preventDefault();var f,g,h=e.expandallcontrol,i=h.data("state"),j=h.find("a"),k="expand"===i;for(f=0;f<e.instances.length;f++)g=e.instances[f],k?g.expand():g.collapse();k?(h.data("state","collapse"),j.addClass("collapse-all"),a.when(c.get_string("collapseall","core"),d.renderIcon("expanded")).done(function(a,b){j.hasClass("collapse-all")&&j.html(b+a)})):(h.data("state","expand"),j.removeClass("collapse-all"),a.when(c.get_string("expandall","core"),d.renderIcon("collapsed")).done(function(a,b){j.hasClass("collapse-all")||j.html(b+a)}))},e});