define(["core/yui","core/templates","core/str"],function(a,b,c){return M.totara_form=M.totara_form||{},M.totara_form.element_filemanager=M.totara_form.element_filemanager||{},M.totara_form.element_filemanager.templates=M.totara_form.element_filemanager.templates||{},M.totara_form.element_filemanager.init=function(a,b){var c=function(a){c.superclass.constructor.apply(this,arguments)};c.NAME="FileManager",c.ATTRS={options:{},lang:{}},a.extend(c,a.Base,{api:M.cfg.wwwroot+"/repository/draftfiles_ajax.php",menus:{},initializer:function(b){this.options=b,b.mainfile&&(this.enablemainfile=b.mainfile),this.client_id=b.client_id,this.currentpath="/",this.maxfiles=b.maxfiles,this.maxbytes=b.maxbytes,this.areamaxbytes=b.areamaxbytes,this.emptycallback=null,this.filepicker_options=b.filepicker?b.filepicker:{},this.filepicker_options.client_id=this.client_id,this.filepicker_options.context=b.context,this.filepicker_options.maxfiles=this.maxfiles,this.filepicker_options.maxbytes=this.maxbytes,this.filepicker_options.areamaxbytes=this.areamaxbytes,this.filepicker_options.env="filemanager",this.filepicker_options.itemid=b.itemid,b.filecount?this.filecount=b.filecount:this.filecount=0,this.filemanager=a.one("#filemanager-"+b.client_id),this.filemanager.hasClass("filemanager-container")||!this.filemanager.one(".filemanager-container")?this.dndcontainer=this.filemanager:(this.dndcontainer=this.filemanager.one(".filemanager-container"),this.dndcontainer.get("id")||this.dndcontainer.generateID()),this.filemanager.one(".fp-path-folder")&&(this.pathnode=this.filemanager.one(".fp-path-folder"),this.pathbar=this.pathnode.get("parentNode"),this.pathbar.removeChild(this.pathnode)),this.selectnode=a.Node.create(M.totara_form.element_filemanager.templates.fileselectlayout),this.selectnode.setAttribute("aria-live","assertive"),this.selectnode.setAttribute("role","dialog"),this.selectnode.generateID();var c="fm-dialog-label_"+this.selectnode.get("id");this.selectui=new M.core.dialogue({draggable:!0,headerContent:'<h3 id="'+c+'">'+M.util.get_string("edit","moodle")+"</h3>",bodyContent:this.selectnode,centered:!0,width:"480px",modal:!0,visible:!1}),a.one("#"+this.selectnode.get("id")).setAttribute("aria-labelledby",c),this.selectui.hide(),this.setup_select_file(),this.setup_buttons(),this.filemanager.one(".fp-content").on(["scroll","resize"],this.content_scrolled,this),this.viewmode=1,this.filemanager.all(".fp-vb-icons,.fp-vb-tree,.fp-vb-details").removeClass("checked"),this.filemanager.all(".fp-vb-icons").addClass("checked"),this.refresh(this.currentpath)},wait:function(){this.filemanager.addClass("fm-updating")},request:function(b,c){var d,e=this.api+"?action="+b.action,f={},g=this;if(b.scope&&(g=b.scope),f.sesskey=M.cfg.sesskey,f.client_id=this.client_id,f.filepath=this.currentpath,f.itemid=this.options.itemid?this.options.itemid:0,b.params)for(d in b.params)f[d]=b.params[d];var h={method:"POST",on:{complete:function(c,d,e){if(!d)return void(window.console.log&&window.console.log("IO FATAL"));var f=null;try{f=a.JSON.parse(d.responseText)}catch(h){return g.print_msg(M.util.get_string("invalidjson","repository"),"error"),void a.error(M.util.get_string("invalidjson","repository")+":\n"+d.responseText)}f&&f.tree&&g.set_current_tree&&g.set_current_tree(f.tree),b.callback(c,f,e)}},arguments:{scope:g},headers:{"Content-Type":"application/x-www-form-urlencoded; charset=UTF-8"},data:build_querystring(f)};b.form&&(h.form=b.form),a.io(e,h),c&&this.wait()},filepicker_callback:function(a){this.filecount++,this.check_buttons(),this.refresh(this.currentpath),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed()},check_buttons:function(){this.filecount>0?this.filemanager.removeClass("fm-nofiles"):this.filemanager.addClass("fm-nofiles"),this.filecount>=this.maxfiles&&this.maxfiles!=-1?this.filemanager.addClass("fm-maxfiles"):this.filemanager.removeClass("fm-maxfiles")},refresh:function(a){var b=this;this.currentpath=a,a?this.currentpath=a:a=this.currentpath,this.request({action:"list",scope:b,params:{filepath:a},callback:function(a,c,d){b.filecount=c.filecount,b.options=c,b.lazyloading={},b.check_buttons(),b.render(c)}},!0)},print_msg:function(b,c){var d=M.util.get_string("error","moodle");if("error"!=c&&(c="info",d=M.util.get_string("info","moodle")),!this.msg_dlg){this.msg_dlg_node=a.Node.create(M.totara_form.element_filemanager.templates.message);this.msg_dlg_node.generateID();this.msg_dlg=new M.core.dialogue({draggable:!0,bodyContent:this.msg_dlg_node,centered:!0,modal:!0,visible:!1}),this.msg_dlg_node.one(".fp-msg-butok").on("click",function(a){a.preventDefault(),this.msg_dlg.hide()},this)}this.msg_dlg.set("headerContent",d),this.msg_dlg_node.removeClass("fp-msg-info").removeClass("fp-msg-error").addClass("fp-msg-"+c),this.msg_dlg_node.one(".fp-msg-text").setContent(a.Escape.html(b)),this.msg_dlg.show()},is_disabled:function(){return null!==this.filemanager.ancestor(".fitem.disabled")},is_frozen:function(){return this.options.frozen||null!==this.filemanager.ancestor('[data-element-frozen="1"]')},setup_buttons:function(){var b=this.filemanager.one(".fp-btn-download"),c=this.filemanager.one(".fp-btn-mkdir"),d=this.filemanager.one(".fp-btn-add");this.is_frozen()?d&&d.hide():d.on("click",this.show_filepicker,this);var e=this.filemanager.one(".dndupload-arrow");e&&(this.is_frozen()?e.hide():e.on("click",this.show_filepicker,this)),this.options.subdirs&&!this.is_frozen()?c.on("click",function(b){if(b.preventDefault(),!this.is_disabled()&&!this.is_frozen()){var c=this,d=function(b){b.preventDefault();var d=a.one("#fm-newname-"+c.client_id).get("value");return d?void c.request({action:"mkdir",params:{filepath:c.currentpath,newdirname:d},callback:function(b,d,e){var f=d.filepath;c.mkdir_dialog.hide(),c.refresh(f),a.one("#fm-newname-"+c.client_id).set("value",""),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed()}}):void c.mkdir_dialog.hide()},e=function(){var b=!1,d=a.one("#fm-newname-"+c.client_id).get("value");d.length>0&&(b=!0);var e=a.one("#fm-mkdir-butcreate-"+c.client_id);return e&&e.set("disabled",!b),b};if(!this.mkdir_dialog){var f=a.Node.create(M.totara_form.element_filemanager.templates.mkdir);this.mkdir_dialog=new M.core.dialogue({draggable:!0,bodyContent:f,centered:!0,modal:!0,visible:!1}),f.one(".fp-dlg-butcreate").set("id","fm-mkdir-butcreate-"+this.client_id).on("click",d,this),f.one("input").set("id","fm-newname-"+this.client_id).on("keydown",function(b){var c=a.bind(e,this)();c&&13===b.keyCode&&a.bind(d,this)(b)},this),f.one("#fm-newname-"+this.client_id).on(["keyup","change"],function(b){a.bind(e,this)()},this),f.one("label").set("for","fm-newname-"+this.client_id),f.all(".fp-dlg-butcancel").on("click",function(a){a.preventDefault(),this.mkdir_dialog.hide()},this),f.all(".fp-dlg-curpath").set("id","fm-curpath-"+this.client_id)}this.mkdir_dialog.show();for(var g=M.util.get_string("newfolder","repository");this.has_folder(g);)g=increment_filename(g,!0);a.one("#fm-newname-"+c.client_id).set("value",g),a.bind(e,this)(),a.one("#fm-newname-"+c.client_id).focus().select(),a.all("#fm-curpath-"+c.client_id).setContent(this.currentpath)}},this):(this.filemanager.addClass("fm-nomkdir"),c&&c.hide()),b.on("click",function(b){if(b.preventDefault(),!this.is_disabled()){var c=this,d=this.filemanager.one(".fp-img-downloading");"inline"!=d.getStyle("display")&&(d.setStyle("display","inline"),this.request({action:"downloaddir",scope:c,callback:function(b,d,e){var f=c.filemanager.one(".fp-img-downloading");if(f.setStyle("display","none"),d){c.refresh(d.filepath);var g=a.Node.create("<iframe></iframe>").setStyles({visibility:"hidden",width:"1px",height:"1px"});g.set("src",d.fileurl),a.one("body").appendChild(g)}else c.print_msg(M.util.get_string("draftareanofiles","repository"),"error")}}))}},this),this.filemanager.all(".fp-vb-icons,.fp-vb-tree,.fp-vb-details").on("click",function(a){a.preventDefault();var b=this.filemanager.one(".fp-viewbar");this.is_disabled()||b&&b.hasClass("disabled")||(this.filemanager.all(".fp-vb-icons,.fp-vb-tree,.fp-vb-details").removeClass("checked"),a.currentTarget.hasClass("fp-vb-tree")?this.viewmode=2:a.currentTarget.hasClass("fp-vb-details")?this.viewmode=3:this.viewmode=1,a.currentTarget.addClass("checked"),this.render(),this.filemanager.one(".fp-content").setAttribute("tabIndex","0"),this.filemanager.one(".fp-content").focus())},this)},show_filepicker:function(b){if(b.preventDefault(),!this.is_disabled()&&!this.is_frozen()){var c=this.filepicker_options;c.formcallback=this.filepicker_callback,c.magicscope=this,c.savepath=this.currentpath,M.core_filepicker.show(a,c)}},print_path:function(){var b=this.options.path;if(this.pathbar.setContent("").addClass("empty"),b&&0!==b.length&&2!=this.viewmode){for(var c=0;c<b.length;c++){var d=this.pathnode.cloneNode(!0);this.pathbar.appendChild(d),0===c&&d.addClass("first"),c===b.length-1&&d.addClass("last"),c%2?d.addClass("even"):d.addClass("odd"),d.one(".fp-path-folder-name").setContent(a.Escape.html(b[c].name)).on("click",function(a,b){a.preventDefault(),this.is_disabled()||this.refresh(b)},this,b[c].path)}this.pathbar.removeClass("empty")}},get_filepath:function(a){return a.path&&a.path.length?a.path[a.path.length-1].path:""},treeview_dynload:function(a,b){var c={};if(a.children)for(var d in a.children)c[a.children[d].path]=a.children[d];a.path&&"/"!=a.path||(a.fileinfo.filepath="/",a.fileinfo.type="folder",a.fileinfo.fullname=a.fileinfo.title,a.fileinfo.filename="."),this.request({action:"list",params:{filepath:a.path?a.path:""},scope:this,callback:function(d,e,f){var g,h=e.list,i=f.scope;if(2==i.viewmode&&a&&a.getChildrenEl()){null!==b&&(i.options=e,i.currentpath=a.path?a.path:"/"),a.highlight(!1),a.origlist=e.list?e.list:null,a.origpath=e.path?e.path:null,a.children=[];for(g in h)"folder"==h[g].type&&c[h[g].filepath]?(c[h[g].filepath].fileinfo=h[g],a.children[a.children.length]=c[h[g].filepath]):i.view_files([h[g]]);null===b?a.refresh():b(),i.content_scrolled()}}},!1)},content_scrolled:function(b){setTimeout(a.bind(function(){if(!this.processingimages){this.processingimages=!0;var a=this,b=this.filemanager.one(".fp-content"),c=b.getY(),d=b.getStylePx("height"),e=function(a){var b=a.getY()-c;return b<=d&&(b>=0||b+a.getStylePx("height")>=0)};a.lazyloading&&b.all("img").each(function(b){b.get("id")&&a.lazyloading[b.get("id")]&&e(b)&&b.setImgRealSrc(a.lazyloading)}),this.processingimages=!1}},this),200)},view_files:function(b){if(this.filemanager.removeClass("fm-updating").removeClass("fm-noitems"),null===b&&(!this.options.list||0===this.options.list.length)&&2!=this.viewmode)return void this.filemanager.addClass("fm-noitems");var c,d=null!==b?b:this.options.list;2==this.viewmode||3==this.viewmode?c=a.Node.create(M.totara_form.element_filemanager.templates.listfilename):(this.viewmode=1,c=a.Node.create(M.totara_form.element_filemanager.templates.iconfilename));var e={viewmode:this.viewmode,appendonly:null!==b,filenode:c,callbackcontext:this,callback:function(a,b){a.preventDefault&&a.preventDefault(),"folder"==b.type?this.refresh(b.filepath):this.select_file(b)},rightclickcallback:function(a,b){a.preventDefault&&a.preventDefault(),this.select_file(b)},classnamecallback:function(b){var c="";return"folder"!=b.type&&(b.type||b.filename)||(c+=" fp-folder"),(b.filename||b.filepath||b.path&&"/"!=b.path)&&(c+=" fp-hascontextmenu"),b.isref&&(c+=" fp-isreference"),b.refcount&&(c+=" fp-hasreferences"),b.originalmissing&&(c+=" fp-originalmissing"),1==b.sortorder&&(c+=" fp-mainfile"),a.Lang.trim(c)}};2==this.viewmode&&(e.dynload=!0,e.filepath=this.options.path,e.treeview_dynload=this.treeview_dynload,e.norootrightclick=!0,e.callback=function(a,b){b.fullname&&("folder"!=b.type?(a.node.parent&&a.node.parent.origpath&&(this.options.path=a.node.parent.origpath,this.options.list=a.node.parent.origlist,this.print_path()),this.currentpath=b.filepath,this.select_file(b)):(this.options.path=a.node.origpath,this.options.list=a.node.origlist,this.currentpath=b.filepath,this.print_path()))}),this.lazyloading||(this.lazyloading={}),this.filemanager.one(".fp-content").fp_display_filelist(e,d,this.lazyloading),this.content_scrolled()},populate_licenses_select:function(b){if(b){b.setContent("");var c=this.options.licenses;for(var d in c){var e=a.Node.create("<option/>").set("value",c[d].shortname).setContent(a.Escape.html(c[d].fullname));b.appendChild(e)}}},set_current_tree:function(b){var c=function(a,b){if(b&&b.children&&b.children.length)for(var d in b.children)a[a.length]=b.children[d].filepath,c(a,b.children[d])},d=["/"];c(d,b);var e=this.selectnode,f=e.one(".fp-path select");f.setContent("");for(var g in d)f.appendChild(a.Node.create("<option/>").set("value",d[g]).setContent(a.Escape.html(d[g])))},update_file:function(b){if(this.is_disabled()||this.frozen())return void this.selectui.hide();var c,d,e=this.selectnode,f=this.selectui.fileinfo,g=a.Lang.trim(e.one(".fp-saveas input").get("value")),h=g&&g!=f.fullname,i=e.one(".fp-path select"),j=i.get("selectedIndex"),k=i.get("options").item(j).get("value"),l=k!=this.get_parent_folder_name(f),m=a.Lang.trim(e.one(".fp-author input").get("value")),n=m!=a.Lang.trim(f.author),o=e.one(".fp-license select"),p=o.get("selectedIndex"),q=o.get("options").item(p).get("value"),r=q!=f.license,s={callback:this.update_file,callbackargs:[!0],scope:this};if("folder"==f.type){if(!g)return void this.print_msg(M.util.get_string("entername","repository"),"error");if(h||l){if(!b)return s.message=M.util.get_string("confirmrenamefolder","repository"),void this.show_confirm_dialog(s);c={filepath:f.filepath,newdirname:g,newfilepath:k},d="updatedir"}}else{if(!g)return void this.print_msg(M.util.get_string("enternewname","repository"),"error");if((h||l)&&!b&&f.refcount)return s.message=M.util.get_string("confirmrenamefile","repository",f.refcount),void this.show_confirm_dialog(s);(h||l||r||n)&&(c={filepath:f.filepath,filename:f.fullname,newfilename:g,newfilepath:k,newlicense:q,newauthor:m},d="updatefile")}return d?(e.addClass("loading"),void this.request({action:d,scope:this,params:c,callback:function(a,b,c){b.error?(e.removeClass("loading"),c.scope.print_msg(b.error,"error")):(c.scope.selectui.hide(),c.scope.refresh(b&&b.filepath?b.filepath:"/"),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed())}})):void this.selectui.hide()},show_confirm_dialog:function(b){if(!this.confirm_dlg){this.confirm_dlg_node=a.Node.create(M.totara_form.element_filemanager.templates.confirmdialog);var c=this.confirm_dlg_node;c.generateID(),this.confirm_dlg=new M.core.dialogue({draggable:!0,bodyContent:c,centered:!0,modal:!0,visible:!1,buttons:{}});var d=function(a){var b=this.confirm_dlg.dlgopt;a.preventDefault(),this.confirm_dlg.hide(),b.callback&&(b.callbackargs?b.callback.apply(b.scope||this,b.callbackargs):b.callback.apply(b.scope||this))},e=function(a){a.preventDefault(),this.confirm_dlg.hide()};c.one(".fp-dlg-butconfirm").on("click",d,this),c.one(".fp-dlg-butcancel").on("click",e,this)}this.confirm_dlg.dlgopt=b,this.confirm_dlg_node.one(".fp-dlg-text").setContent(b.message),this.confirm_dlg.show()},setup_select_file:function(){var a=this.selectnode;a.all(".fp-saveas,.fp-path,.fp-author,.fp-license").each(function(a){a.all("label").set("for",a.one("input,select").generateID())}),this.populate_licenses_select(a.one(".fp-license select"));var b=a.one(".fp-file-update"),c=a.one(".fp-file-download"),d=a.one(".fp-file-delete"),e=a.one(".fp-file-zip"),f=a.one(".fp-file-unzip"),g=a.one(".fp-file-setmain"),h=a.all(".fp-file-cancel");this.is_frozen()?(b&&b.hide(),d&&d.hide(),e&&e.hide(),f&&f.hide(),g&&g.hide(),a.all("form input").each(function(){this.setAttribute("readonly","readonly")}),a.all("form select").each(function(){this.setAttribute("disabled","disabled")})):(b.on("click",function(a){a.preventDefault(),this.update_file()},this),a.all("form").on("keydown",function(a){13==a.keyCode&&(a.preventDefault(),this.update_file())},this),d.on("click",function(a){a.preventDefault();var b={},c={},d=this.selectui.fileinfo;b.scope=this,c.filepath=d.filepath,"folder"==d.type?(c.filename=".",b.message=M.util.get_string("confirmdeletefolder","repository")):(c.filename=d.fullname,d.refcount?b.message=M.util.get_string("confirmdeletefilewithhref","repository",d.refcount):b.message=M.util.get_string("confirmdeletefile","repository")),b.callbackargs=[c],b.callback=function(a){this.request({action:"delete",scope:this,params:a,callback:function(a,b,c){c.scope.filecount--,c.scope.refresh(b.filepath),"undefined"!=typeof M.core_formchangechecker&&M.core_formchangechecker.set_form_changed()}})},this.selectui.hide(),this.show_confirm_dialog(b)},this),e.on("click",function(b){b.preventDefault();var c={},d=this.selectui.fileinfo;"folder"==d.type&&(c.filepath=d.filepath,c.filename=".",a.addClass("loading"),this.request({action:"zip",scope:this,params:c,callback:function(a,b,c){c.scope.selectui.hide(),c.scope.refresh(b.filepath)}}))},this),f.on("click",function(b){b.preventDefault();var c={},d=this.selectui.fileinfo;"zip"==d.type&&(c.filepath=d.filepath,c.filename=d.fullname,a.addClass("loading"),this.request({action:"unzip",scope:this,params:c,callback:function(a,b,c){c.scope.selectui.hide(),c.scope.refresh(b.filepath)}}))},this),g.on("click",function(b){b.preventDefault();var c={},d=this.selectui.fileinfo;this.enablemainfile&&"folder"!=d.type&&(c.filepath=d.filepath,c.filename=d.fullname,a.addClass("loading"),this.request({action:"setmainfile",scope:this,params:c,callback:function(a,b,c){c.scope.selectui.hide(),c.scope.refresh(d.filepath)}}))},this)),c.on("click",function(a){a.preventDefault(),"folder"!=this.selectui.fileinfo.type&&(/iPad|iPhone|iPod/.test(navigator.userAgent)?window.open(this.selectui.fileinfo.url,"_blank"):window.location=this.selectui.fileinfo.url)},this),h.on("click",function(a){a.preventDefault(),this.selectui.hide()},this)},get_parent_folder_name:function(a){if("folder"!=a.type||a.filepath.length<a.fullname.length+1)return a.filepath;var b=a.filepath.substr(0,a.filepath.length-a.fullname.length-1),c=a.filepath.substr(a.filepath.length-a.fullname.length-2);return c=="/"+a.fullname+"/"?b:a.filepath},select_file:function(b){if(!this.is_disabled()){var c=this.selectnode;c.removeClass("loading").removeClass("fp-folder").removeClass("fp-file").removeClass("fp-zip").removeClass("fp-cansetmain"),"folder"==b.type||"zip"==b.type?c.addClass("fp-"+b.type):c.addClass("fp-file"),this.enablemainfile&&1!=b.sortorder&&"file"==b.type&&c.addClass("fp-cansetmain"),this.selectui.fileinfo=b,c.one(".fp-saveas input").set("value",b.fullname);var d=this.get_parent_folder_name(b);c.all(".fp-author input").set("value",b.author?b.author:""),c.all(".fp-license select option[selected]").set("selected",!1),c.all(".fp-license select option[value="+b.license+"]").set("selected",!0),c.all(".fp-path select option[selected]").set("selected",!1),c.all(".fp-path select option").each(function(a){a.get("value")==d&&a.set("selected",!0)}),this.is_frozen()?(c.all(".fp-author input").setAttribute("readonly","readonly"),c.all(".fp-license select").setAttribute("disabled","disabled")):(c.all(".fp-author input").setAttribute("readonly","folder"==b.type?"readonly":""),c.all(".fp-license select").setAttribute("disabled","folder"==b.type?"disabled":""));var e=["datemodified","datecreated","size","dimensions","original","reflist"];for(var f in e)if(c.one(".fp-"+e[f])){var g=b[e[f]+"_f"]?b[e[f]+"_f"]:b[e[f]]?b[e[f]]:"";"reflist"!==e[f]&&(g=a.Escape.html(g)),c.one(".fp-"+e[f]).addClassIf("fp-unknown",""+g=="").one(".fp-value").setContent(g)}var h=a.Node.create("<img/>").set("src",b.realthumbnail?b.realthumbnail:b.thumbnail).setStyle("maxHeight",""+(b.thumbnail_height?b.thumbnail_height:90)+"px").setStyle("maxWidth",""+(b.thumbnail_width?b.thumbnail_width:90)+"px");c.one(".fp-thumbnail").setContent("").appendChild(h),b.isref&&!b.original&&(c.one(".fp-original").removeClass("fp-unknown").addClass("fp-loading"),this.request({action:"getoriginal",scope:this,params:{filepath:b.filepath,filename:b.fullname},callback:function(d,e,f){var g=f.scope;g.selectui.fileinfo&&b&&g.selectui.fileinfo.filepath==b.filepath&&g.selectui.fileinfo.fullname==b.fullname&&(c.one(".fp-original").removeClass("fp-loading"),e.original?(b.original=e.original,c.one(".fp-original .fp-value").setContent(a.Escape.html(b.original))):c.one(".fp-original .fp-value").setContent(M.util.get_string("unknownsource","repository")))}},!1)),c.one(".fp-refcount").setContent(b.refcount?M.util.get_string("referencesexist","repository",b.refcount):""),b.refcount&&!b.reflist&&(c.one(".fp-reflist").removeClass("fp-unknown").addClass("fp-loading"),this.request({action:"getreferences",scope:this,params:{filepath:b.filepath,filename:b.fullname},callback:function(d,e,f){var g=f.scope;if(g.selectui.fileinfo&&b&&g.selectui.fileinfo.filepath==b.filepath&&g.selectui.fileinfo.fullname==b.fullname)if(c.one(".fp-reflist").removeClass("fp-loading"),e.references){b.reflist="";for(var h in e.references)b.reflist+="<li>"+a.Escape.html(e.references[h])+"</li>";c.one(".fp-reflist .fp-value").setContent(b.reflist)}else c.one(".fp-reflist .fp-value").setContent("")}},!1));var i=b.fullname,j=50;i.length>j&&(i=i.substring(0,j)+"...");var k=M.util.get_string("edit","moodle")+" "+i;a.one("#fm-dialog-label_"+c.get("id")).setContent(a.Escape.html(k)),this.selectui.show(),a.one("#"+c.get("id")).focus()}},render:function(){this.print_path(),this.view_files(null)},has_folder:function(a){var b;for(var c in this.options.list)if(b=this.options.list[c],"folder"==b.type&&b.fullname==a)return!0;return!1}});var d=a.one("#filemanager-"+b.client_id);d.removeClass("fm-loading").addClass("fm-loaded");var e=new c(b);if(!b.frozen){var f={filemanager:e,acceptedtypes:b.filepicker.accepted_types,clientid:b.client_id,author:b.author,maxfiles:b.maxfiles,maxbytes:b.maxbytes,areamaxbytes:b.areamaxbytes,itemid:b.itemid,repositories:e.filepicker_options.repositories,containerid:e.dndcontainer.get("id"),contextid:b.context.id};M.form_dndupload.init(a,f)}},{init_filemanager:function(b){var d=[];d.push({key:"edit",component:"moodle"}),d.push({key:"invalidjson",component:"repository"}),d.push({key:"error",component:"moodle"}),d.push({key:"info",component:"moodle"}),d.push({key:"newfolder",component:"repository"}),d.push({key:"invalidjson",component:"repository"}),d.push({key:"draftareanofiles",component:"repository"}),d.push({key:"entername",component:"repository"}),d.push({key:"confirmrenamefolder",component:"repository"}),d.push({key:"enternewname",component:"repository"}),d.push({key:"confirmrenamefile",component:"repository"}),d.push({key:"confirmdeletefolder",component:"repository"}),d.push({key:"confirmdeletefilewithhref",component:"repository"}),d.push({key:"confirmdeletefile",component:"repository"}),d.push({key:"unknownsource",component:"repository"}),d.push({key:"referencesexist",component:"repository"}),d.push({key:"unknownsource",component:"repository"}),d.push({key:"unknownsource",component:"repository"}),c.get_strings(d).done(function(){var c=["moodle-core-notification-dialogue","core_filepicker","base","io-base","node","json","core_dndupload","panel","resize-plugin","dd-plugin"];a.use(c,function(a){M.core_filepicker.set_templates(a,b.filepicker.fptemplates),b.filepicker.fptemplates=null,M.totara_form.element_filemanager.templates=b.fmtemplates,b.fmtemplates=null,M.totara_form.element_filemanager.init(a,b)})})}}});