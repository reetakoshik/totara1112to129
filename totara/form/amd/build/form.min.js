define(["jquery","core/config","core/templates","core/notification"],function(a,b,c,d){function e(a){var b=new Promise(function(b){var c=document.getElementById(a),d=function(){"true"===c.getAttribute("data-totara_form-initialised")&&(e.disconnect(),b())},e=new MutationObserver(d);e.observe(c,{attributes:!0,attributeFilter:["data-totara_form-initialised"]})});return b}function f(a,b,c,d){return this instanceof f?(this.parent=a,this.type=b,this.id=c,void(this.node=d)):new f(a,b,c,d)}function g(){this.elements={}}function h(a,b,c){return this instanceof h?(f.call(this,a,"totara_form\\form\\group",b,c),void g.call(this)):new h(a,b,c)}function i(c){return this instanceof i?(["el"].forEach(function(a){if(!c.hasOwnProperty(a)){var b='Missing required config property "'+a+'"';throw new Error(b)}}),this.node=c.el,this.id=c.el.getAttribute("id"),this.clientActions=[],this.actionListeners=[],this.form=a(this.node),this.form.data("TotaraForm",this),this.form.attr("action")===b.wwwroot+"/totara/form/ajax.php"&&(k.debug("Form submission for "+this.id+" is being directed via ajaxSubmit",this,k.LOGLEVEL.info),this.form.on("submit.ajaxSubmit",a.proxy(function(a){a.preventDefault(),this.ajaxSubmit(this.form.find("input[type=submit]:focus"))},this))),void g.call(this)):new i(c)}var j=!(!window.console||!b.hasOwnProperty("developerdebug"))&&b.developerdebug;f.prototype={toString:function(){return"[object Element]"},init:function(a){a()},getId:function(){return this.id},getType:function(){return this.type},getNode:function(){return this.node},getValue:function(){return null},compare:function(a){var b=this.getValue(),c=[b].concat(Array.prototype.slice.call(arguments));return i.prototype.compare.apply(null,c)},isEmpty:function(){var a=this.getValue();return null===a||""===a||0===a||a===[]||!!a.hasOwnProperty("isEmpty")&&a.isEmpty()},isHidden:function(){return null!==this.node.getAttribute("data-hidden")},setHidden:function(a){a?(k.debug("#"+this.id+" is now hidden",this,k.LOGLEVEL.debug),this.node.setAttribute("data-hidden","")):(k.debug("#"+this.id+" is no longer hidden",this,k.LOGLEVEL.debug),this.node.removeAttribute("data-hidden"))},changed:function(a){this.getForm().valueChanged(this.getId(),this.getValue())},disable:function(){return!!this.input&&(this.input.setAttribute("disabled",""),!0)},enable:function(){return!!this.input&&(this.input.removeAttribute("disabled"),!0)},isDisabled:function(){return this.input?null!==this.input.getAttribute("disabled"):null},isEnabled:function(){return this.input?null===this.input.getAttribute("disabled"):null},getForm:function(){var a=0,b=function(c){if(a++,a>10)throw"Coding error: element nesting is too deep!";return c.hasOwnProperty("parent")?b(c.parent):c};return b(this.parent)}},g.prototype={registerItem:function(a){j&&this.elements[a.getId()]&&k.debug("Item being registered already exists #"+a.getId(),g,k.LOGLEVEL.error),this.elements[a.getId()]=a},registerGroup:function(a,b){this.registerItem(a);var c=!0;if(j){var d=3e3;window.setTimeout(function(){c===!0&&k.debug("Element #"+a.getId()+" failed to call done() in "+d+"ms",a,k.LOGLEVEL.error)},d)}k.debug("Registered group #"+a.getId()+" of type "+a.getType(),a,k.LOGLEVEL.debug),a.init(function(){k.debug("Completed initialisation of #"+a.getId(),a,k.LOGLEVEL.debug),c=!1,b.resolve(a)})},registerElement:function(a,b){this.registerItem(a);var c=!0;if(j){var d=3e3;window.setTimeout(function(){c===!0&&k.debug("Element #"+a.getId()+" failed to call done() in "+d+"ms",a,k.LOGLEVEL.error)},d)}k.debug("Registered element #"+a.getId()+" of type "+a.getType(),a,k.LOGLEVEL.debug),a.init(function(){k.debug("Completed initialisation of #"+a.getId(),a,k.LOGLEVEL.debug),c=!1,b.resolve(a)})},filterItems:function(b,c,d){var e=[],f=[];if(void 0===d&&(d=0),d++,d>6)return k.debug("Filtering depth exceeds known limits, coding error!",this,k.LOGLEVEL.error),e;if(d>4&&k.debug("Filtering depth nearing limit, check you need this level of depth!",this,k.LOGLEVEL.warn),"function"!=typeof b)throw new Error("You must provide a filter function for filterItems()");for(var g in this.elements)if(this.elements.hasOwnProperty(g)){var i=this.elements[g];b(i)===!0&&(e[g]=i),c===!0&&i instanceof h&&(f=i.filterItems(b,!0,d),e=a.extend(e,f))}return e},getElements:function(a){return this.filterItems(function(a){return!(a instanceof h)&&a instanceof f},a)},getGroups:function(a){return this.filterItems(function(a){return a instanceof h},a)},getElementById:function(a){var b=this.getElements(!0);return b[a]},getGroupById:function(a){var b=this.getGroups(!0);return b[a]},getItemById:function(b){var c=a.extend(this.getElements(!0),this.getGroups(!0));return c[b]},map:function(a){var b=this.elements,c=[];for(var d in b)b.hasOwnProperty(d)&&c.push(a(b[d]));return c},disable:function(){return this.map(function(a){a.disable()}),this},enable:function(){return this.map(function(a){a.enable()}),this},isDisabled:function(){var a=this.map(function(a){return a.isDisabled()});return a.indexOf(!1)===-1},isEnabled:function(){var a=this.map(function(a){return a.isEnabled()});return a.indexOf(!1)===-1},isValid:function(){return this.getElements(!0).every(function(a){if("function"!=typeof a.isValid)return!0;var b=a.isValid();return b||"function"!=typeof a.displayError||a.displayError(),b})},toString:function(){return"[object ElementCollection]"},findItemNodes:function(b){var c=k.attributeIdentifiers.CLASSIFICATION+'="'+k.itemIdentifiers.ELEMENT+'"',d=k.getDataAttributeSelector(c),e=k.attributeIdentifiers.CLASSIFICATION+'="'+k.itemIdentifiers.GROUP+'"',f=k.getDataAttributeSelector(e),g=a(b),h=g.find([d,f].join(", ")).get();return h=Array.prototype.filter.call(h,function(b){return 0===a(b).parentsUntil(g,f).length})},getItemNodes:function(){return this.findItemNodes(this.node)},initGroup:function(b){var c,d,e=this,f={},g=k.attributeIdentifiers,i=a.Deferred();if([g.TYPE,g.ID,g.MODULE].forEach(function(a){f[a.split("-").pop()]=b.getAttribute(a)}),f.module)require([f.module],function(c){var d=new c(e,f.id,b),g=d.getItemNodes(),h=a.Deferred();e.registerGroup(d,h),h.done(function(){d.initItems(g).then(function(){i.resolve()},function(a){k.debug("Failed to initialise the items within a group of type "+f.module,e,k.LOGLEVEL.error),i.reject()})})});else{c=new h(this,f.id,b),d=c.getItemNodes();var j=a.Deferred();this.registerGroup(c,j),j.done(function(){c.initItems(d).done(function(){i.resolve()})})}return i.promise()},initElement:function(b){var c=this,d=a.Deferred(),e={},f=k.attributeIdentifiers;return[f.TYPE,f.ID,f.MODULE].forEach(function(a){e[a.split("-").pop()]=b.getAttribute(a)}),e.module||(e.module="totara_form/element_generic"),require([e.module],function(a){var f=new a(c,e.type,e.id,b);c.registerElement(f,d)}),d.promise()},initItems:function(b){var c=Array.prototype.map.call(b,function(a){return a.getAttribute(k.attributeIdentifiers.CLASSIFICATION)===k.itemIdentifiers.GROUP?this.initGroup(a):a.getAttribute(k.attributeIdentifiers.CLASSIFICATION)===k.itemIdentifiers.ELEMENT?this.initElement(a):void 0},this);return a.when.apply(a,c)}},h.prototype=Object.create(f.prototype),a.extend(h.prototype,g.prototype),h.prototype.constructor=h,h.prototype.toString=function(){return"[object Group]"},h.prototype.init=function(a){a()},i.prototype=Object.create(g.prototype),i.prototype.constructor=i,a.extend(i.prototype,{toString:function(){return"[object Form]"},initClientActions:function(b){var c=this,d=b.map(function(a){return c.initClientAction(a).done(function(a){c.clientActions.push(a)})});return a.when.apply(a,d).done(function(){c.checkAllClientActionStates()})},initClientAction:function(b){var c=this,d=a.Deferred(),e=this.convertTypeToModule(b.actionType);if(!e)throw new Error("Unknown action of type ["+b.actionType+"]");return require([e],function(a){a.init(b,c,function(a){d.resolve(a)})}),d.promise()},convertTypeToModule:function(a){var b=a.split("\\"),c=b[0],d=b.slice(1).join("_"),e=c+"/"+d;return k.debug("Found module to be ["+e+"] from type ["+a+"] by split.",i,k.LOGLEVEL.debug),e},checkModuleExists:function(a){return require.specified(a)},valueChanged:function(a){k.debug("Value of #"+a+" changed",this,k.LOGLEVEL.info),this.checkClientActionState(a)},checkClientActionState:function(a){var b=this.setFormWorking("checkaction");k.debug("Checking ClientActions on #"+a,this,k.LOGLEVEL.debug),this.clientActions.forEach(function(b){b.getWatchedIds().indexOf(a)!==-1&&b.checkState()}),b.resolve()},checkAllClientActionStates:function(){var a=this.setFormWorking("checkallactions");k.debug("Checking the state of all ClientActions",this,k.LOGLEVEL.debug);for(var b in this.clientActions)this.clientActions.hasOwnProperty(b)&&this.clientActions[b].checkState();a.resolve()},addActionListener:function(a){this.actionListeners.push(a)},callActionListener:function(a,b){for(var c in this.actionListeners)this.actionListeners.hasOwnProperty(c)&&this.actionListeners[c].hasOwnProperty(a)&&this.actionListeners[c][a].apply(this,b)},submit:function(){this.form.trigger("submit")},reload:function(a){this.ajaxSubmit(a,!0)},ajaxSubmit:function(c,d){d=d||!1,d?k.debug("Reloading form #"+this.id,this,k.LOGLEVEL.info):k.debug("Submitting form #"+this.id+" by AJAX",this,k.LOGLEVEL.info);var e=this.form.serializeArray(),f=a.Deferred(),g=this.setFormWorking("ajaxsubmit");return f.done(function(){g.resolve()}),void 0!==c&&e.push({name:c.attr("name"),value:c.val()}),d&&(e.push({name:"___tf_reload",value:1}),e.push({name:"___tf_original_action",value:this.form.attr("action")})),a.ajax({type:"POST",url:b.wwwroot+"/totara/form/ajax.php",data:e,context:this,success:function(a){this.ajaxSubmitHandler(f,a)},error:function(a,b,c){f.reject(a,b,c)},dataType:"json"}),f},ajaxSubmitHandler:function(b,e){var f=this;b.done(function(a,b){f.callActionListener(a,[f,b])}),"display"===e.formstatus?(k.debug("Displaying the form after an AJAX reload.",i,k.LOGLEVEL.info),c.render(e.templatename,e.templatedata).done(a.proxy(this.replaceFormContents,this),b.resolve(e.formstatus,e.templatedata.formid)).fail(d.exception)):"cancelled"===e.formstatus?(b.done(function(){k.debug("The form has been cancelled, the calling JS needs to do something.",i,k.LOGLEVEL.success)}),b.resolve(e.formstatus,e)):"submitted"===e.formstatus?(b.done(function(){k.debug("The form has been successfully submit, the calling JS needs to do something.",i,k.LOGLEVEL.success)}),b.resolve(e.formstatus,e.data)):(b.done(function(){k.debug("Unexpected reload result.",i,k.LOGLEVEL.error)}),b.resolve("unknown",e))},replaceFormContents:function(a,b){c.replaceNode(this.form,a,b),M.util.js_pending("totara_form-replaceform"),e(this.form.attr("id")).then(function(){M.util.js_complete("totara_form-replaceform")})},compare:function(b,c){if(null!==b&&!Array.isArray(b)&&("function"==typeof b||"object"==typeof b))return!1;var d,e,f,g=i.prototype.compare,h=Array.isArray(b),j=null;switch(c){case i.Operators.Equals:if(3!==arguments.length)return e=arguments.length,k.debug("Compare NotEquals expects 3 arguments, "+e+" given.",i,k.LOGLEVEL.error),j;if(d=arguments[2],Array.isArray(d))if(!h||b.length<d.length)j=!1;else{j=!0;for(f in d)if(d.hasOwnProperty(f)&&!a.inArray(d[f],b)){j=!1;break}}else if(h){for(f in b)if(b.hasOwnProperty(f)&&b[f].toString()===d.toString()){j=!0;break}}else null===b&&(b=""),j=b.toString()===d.toString();break;case i.Operators.Empty:j=null===b||b===!1||""===b.toString()||"0"===b.toString()||h&&0===b.length;break;case i.Operators.Filled:h?j=b.length>0:(null===b&&(b=""),b=b.toString().trim(),j=""!==b&&"false"!==b.toLowerCase()&&!/^[0]*$/.test(b));break;case i.Operators.NotEquals:if(3!==arguments.length)return e=arguments.length,k.debug("Compare NotEquals expects 3 arguments, "+e+" given.",i,k.LOGLEVEL.error),j;d=arguments[2],j=!g(b,i.Operators.Equals,d);break;case i.Operators.NotEmpty:j=!g(b,i.Operators.Empty);break;case i.Operators.NotFilled:j=!g(b,i.Operators.Filled);break;default:k.debug('Unknown comparison operator given: "'+c+'"',i,k.LOGLEVEL.error)}return j},submitHandler:function(b){var c=b.data.form;if(b.preventDefault(),c.isValid()){var d=a(b.target);d.unbind("submit",c.submitHandler),d.submit()}else k.debug("Failed validation, the responsible element should identify itself.",i,k.LOGLEVEL.warn)},setCustomValidation:function(){var b=a(this.node),c=this;c.node.setAttribute("novalidate",""),b.on("submit.working",{form:c},c.submitHandler)},setFormWorking:function(b){k.debug("Form working on "+b+' "'+this.id+'"',i,k.LOGLEVEL.debug);var c=a.Deferred(),d=this;return c.done(function(){d.setFormReady(b)}),M.util.js_pending("totaraForm_"+this.id+"_"+b),this.form&&this.form.on("submit.working",this.preventSubmissionOnSubmit),c},setFormReady:function(a){k.debug("Form ready after "+a+' "'+this.id+'"',i,k.LOGLEVEL.debug),this.form&&this.form.off("submit.working",this.preventSubmissionOnSubmit),M.util.js_complete("totaraForm_"+this.id+"_"+a)},preventSubmissionOnSubmit:function(a){a.preventDefault()},showLoading:function(){a(k.LOADING,this.node).length>0&&a(k.LOADING,this.node).show()},hideLoading:function(){a(k.LOADING,this.node).length>0&&a(k.LOADING,this.node).hide()}}),i.Operators={Equals:"equals",Empty:"empty",Filled:"filled",NotEquals:"notequals",NotEmpty:"notempty",NotFilled:"notfilled"};var k={Operators:i.Operators,Element:f,Group:h,forms:{},listenerQueue:{},itemIdentifiers:{FORM:"data-totara-form",ELEMENT:"element",GROUP:"group",INPUT:"data-totara-form-element-input",LOADING:".tf_loading_form"},attributeIdentifiers:{ID:"data-element-id",TYPE:"data-element-type",MODULE:"data-element-amd-module",CLASSIFICATION:"data-item-classification"},LOGLEVEL:{none:"none",debug:"debug",info:"info",success:"success",warn:"warn",error:"error"},getDataAttributeSelector:function(a){return"["+a+"]"},init:function(b){k.debug("Initialising form #"+b.id,i,k.LOGLEVEL.info);var c=a("#"+b.id);if(0===c.length)throw new Error("Unable to find form #"+b.id);c=c[0],k.debug("Preventing form #"+b.id+" submission during bootstrapping",i,k.LOGLEVEL.debug);var d,e=new i({el:c}),f=b.actionsConfig,g=a.Deferred();this.forms[e.id]=e,this.listenerQueue.hasOwnProperty(e.id)&&e.addActionListener(this.listenerQueue[e.id]);var h=e.setFormWorking("init");if(d=e.getItemNodes(),0===d.length)throw new Error("Form [#"+this.id+"] must contain at least one element or group.");return e.initItems(d).then(function(){e.initClientActions(f).done(function(){g.resolve(e)})},function(a){k.debug("Failed to initialise items in form #"+b.id,i,k.LOGLEVEL.info)}),g.promise().done(function(a){var c=a.node;k.debug("Re-enabling submission of form #"+c.getAttribute("id"),i,k.LOGLEVEL.debug);var d=a.getElements(!0).some(function(a){return"function"==typeof a.isValid});d&&a.setCustomValidation(),c.setAttribute("data-totara_form-initialised",!0),h.resolve(),k.debug("Initialised form #"+b.id+".",i,k.LOGLEVEL.success)})},extend:function(b,c,d){return c&&"undefined"!==c||(c=function(){b.apply(this,arguments)}),c.prototype=Object.create(b.prototype),c.prototype.constructor=c,a.extend(c.prototype,d),c},load:function(f,g,h,j){var l=a.extend(h,{sesskey:b.sesskey,___tf_formclass:f,___tf_idsuffix:g}),m=a("#"+j),n=a.Deferred();return M.util.js_pending("totara_form-loading"),a.ajax({url:b.wwwroot+"/totara/form/ajax.php",data:l,context:this,success:function(b){"display"===b.formstatus?(k.debug("Displaying the form for the first time.",i,k.LOGLEVEL.debug),m.empty(),c.render(b.templatename,b.templatedata).done(function(d,f){c.replaceNodeContents(a("#"+j),d,f),e(b.templatedata.formid).then(function(){M.util.js_complete("totara_form-loading"),n.resolve("display",b.templatedata.formid)})}).fail(d.exception)):(k.debug("Unexpected form response",i,k.LOGLEVEL.warn),n.reject())},error:function(a,b,c){n.reject(a,b,c)},dataType:"json"}),n.promise()},getFormInstance:function(a){return this.forms.hasOwnProperty(a)?this.forms[a]:null},addActionListeners:function(a,b){var c=this.getFormInstance(a);null===c?this.listenerQueue[a]=b:c.addActionListener(b)},debug:function(a,b,c){if(j){if(!window.console.log.apply)return void(window.console.log&&window.console.log(a));c||(c=k.LOGLEVEL.none),a=b?b.prototype&&b.prototype.constructor&&b.prototype.constructor.name?"%cForm."+b.prototype.constructor.name+": %c"+a:b.constructor&&b.constructor.name?"%cForm."+b.constructor.name+": %c"+a:"%cForm: %c"+a:"%cForm: %c"+a;var d="#cb8bbe",e="#ae45a3";switch(c){case k.LOGLEVEL.debug:window.console.log.apply(window.console,[a,"color: "+d+"; font-style: italic; padding-left:2em;","color: #454545; font-style: italic;"]);break;case k.LOGLEVEL.error:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #c74939;"]);break;case k.LOGLEVEL.warn:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #c68c25;"]);break;case k.LOGLEVEL.success:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #2da833;"]);break;case k.LOGLEVEL.info:window.console.log.apply(window.console,[a,"color: "+e+"; font-weight: bold;","color: #235aac;"]);break;default:window.console.log.apply(window.console,[a,"",""])}}}};return k});