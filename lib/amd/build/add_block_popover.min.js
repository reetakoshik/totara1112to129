define(["jquery","core/templates","core/str","core/flex_icon"],function(a,b,c,d){function e(){if(!(this instanceof e))return new e}e.prototype={constructor:e,addToPage:function(e,f){var g=this;null!==document.querySelector('[data-addblock="'+f+'"]')&&(M.util.js_pending("core_add_block"),c.get_strings([{key:"closebuttontitle",component:"core"},{key:"search",component:"core"}]).then(function(b){return a.when(d.getIconData("delete","core",{alt:b[0]}),d.getIconData("search","core",{alt:b[1]}))}).then(function(a,c){var d={contenttemplate:"core/add_block_popover_content",contenttemplatecontext:{close_icon:a,has_focus:!0,item_list:e,placement_max_height:600,placement_max_width:600,search_icon:c},arrow_placement:"smartPosition",close_on_focus_out:!0,trigger:"click"};return b.render("core/popover",d)}).then(function(a,c){var d,e=document.querySelector('[data-addblock="'+f+'"]'),h=document.createRange(),i=e.parentNode;h.selectNode(e),d=h.createContextualFragment(a),e.appendChild(d),b.runTemplateJS(c),g.events(i,e),M.util.js_complete("core_add_block")}))},changeListItemFocus:function(a){var b=a.target.closest(".addBlockPopover--results_list_item"),c=a.target.closest(".addBlockPopover--results");if("38"==a.keyCode)for(;b.previousElementSibling&&(b=b.previousElementSibling,b.classList.contains("hide")););else if("40"==a.keyCode)for(;b.nextElementSibling&&(b=b.nextElementSibling,b.classList.contains("hide")););b.classList.contains("hide")||(b.querySelector("a").focus(),c.scrollTop=b.offsetTop)},closeAddBlockPopover:function(b){a(b).popover("hide")},events:function(b,c){var d=this;b.addEventListener("click",function(a){a.preventDefault(),a.target&&(a.target.closest("[data-addblockpopover-close]")&&d.closeAddBlockPopover(c),a.target.closest(".addBlockPopover--results_list_item")&&d.submitAddBlock(this,a.target.closest(".addBlockPopover--results_list_item")))}),b.addEventListener("keydown",function(a){a.target&&(!a.target.closest(".addBlockPopover--results_list_item")||"38"!=a.keyCode&&"40"!=a.keyCode?a.target.closest("#addBlockPopover--search_query")&&a.shiftKey&&9==a.keyCode&&d.closeAddBlockPopover(c):(a.preventDefault(),d.changeListItemFocus(a)))}),b.addEventListener("keyup",function(a){a.target&&("27"==a.keyCode&&d.closeAddBlockPopover(c),a.target.closest("#addBlockPopover--search_query")&&("13"==a.keyCode?d.searchListEnter(b):d.searchListItems(b,a)))}),b.addEventListener("focusout",function(a){a.target&&a.relatedTarget&&a.target.closest(".addBlockPopover--close")&&!a.relatedTarget.closest(".popover")&&d.closeAddBlockPopover(c)}),a(c).on("shown.bs.popover",function(){d.setFocusToInput(b)})},searchListEnter:function(a){var b=a.querySelectorAll(".popover .addBlockPopover--results_list_item:not(.hide)");1===b.length?this.submitAddBlock(a,b[0]):b.length>=2&&b[0].querySelector("a").focus()},searchListItems:function(a,b){for(var c=b.target.value.toLowerCase(),d=a.querySelectorAll(".popover .addBlockPopover--results_list_item"),e=0;e<d.length;e++){var f=d[e],g=f.getAttribute("data-addblockpopover-blocktitle");if(g.toLowerCase().indexOf(c)===-1)f.classList.add("hide");else{f.classList.remove("hide");var h=f.querySelector("a");h.innerHTML=g.replace(new RegExp(c,"i"),"<b>$&</b>")}}},setFocusToInput:function(a){a.querySelector(".popover #addBlockPopover--search_query").focus()},submitAddBlock:function(a,b){b.closest(".addBlockPopover").classList.add("addBlockPopover--overlay");var c=b.getAttribute("data-addblockpopover-blockname");a.querySelector("input[name=bui_addblock]").setAttribute("value",c),a.querySelector("form").submit()}};var f=function(a,b){var c=new e;c.addToPage(a,b)};return{init:f}});