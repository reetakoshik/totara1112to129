define(["core/mustache","jquery","core/ajax","core/str","core/notification","core/url","core/config","core/localstorage","core/event","core/flex_icon"],function(a,b,c,d,e,f,g,h,i,j){String.prototype.startsWith||(String.prototype.startsWith=function(a,b){return b=b||0,this.substr(b,a.length)===a});var k={},l={},m=function(c,f,h){var i=b.Deferred(),j=[],k=[],l=[],m="",o=[],p=!0,r=!0,s=function(a){var b="",c=n(a);return c.done(function(a){b=a}).fail(e.exception),""===b&&(l.push(c),p=!1),b},t=function(a,b){var c=a.split(","),d="",e="",f="";c.length>0&&(d=c.shift().trim(),d=b(d,this)),c.length>0&&(e=c.shift().trim()),c.length>0&&(f=c.join(",").trim()),""!==f&&(f=b(f,this)),0===f.indexOf("{")&&0!==f.indexOf("{{")&&(f=JSON.parse(f));var g=o.length;return o.push({key:d,component:e,param:f}),"[[_s"+g+"]]"},u=function(a,b){var c="",d="",e={},f=a.split(",").map(function(a){return a.trim()});f.length>0&&(c=f.shift().trim()),f.length>0&&(d=f.join(",").trim()),c.indexOf("{{")!==-1&&(c=b(c,this)),""!==d&&(d.indexOf("{{")!==-1&&(d=b(d,this)),e=JSON.parse(d));var g="",h="",i=k.length;return"undefined"!=typeof e.alt&&(g=e.alt),e.classes&&(h=e.classes),k.push(q(c,g,h,e)),"<_p"+i+">"},v=function(a,b){var c=a.split(","),d="",e="",f="",g="",h="";c.length>0&&(d=b(c.shift().trim(),this)),c.length>0&&(e=b(c.shift().trim(),this)),c.length>0&&(f=b(c.join(",").trim(),this));try{h=JSON.parse(f)}catch(i){h={alt:f}}return""==e&&(e="core"),g="flexicon"===e?d+","+f:e+"|"+d+","+JSON.stringify(h),u.apply(this,[g,b])},w=function(a,b){return j.push(b(a,this)),""},x=function(a,b){var c=b(a.trim(),this);return c=c.replace('"','\\"').replace(/([\{\}]{2,3})/g,"{{=<% %>=}}$1<%={{ }}=%>"),'"'+c+'"'};f.str=function(){return t},f.pix=function(){return v},f.flex_icon=function(){return u},f.js=function(){return w},f.quote=function(){return x},f.globals={config:g};var y=b.Deferred(),z=function(){b.when.apply(b,l).done(function(){if(p&&!r)y.resolve();else{r=!1,j=[],k=[],l=[],m="",o=[],p=!0;try{m=a.render(c,f,s),z()}catch(b){i.reject(b)}}})};return z(),y.done(function(){for(var a=0;a<k.length;a++)k[a].done(function(a){return function(b,c){j.push(c),m=m.replace("<_p"+a+">",b)}}(a));b.when.apply(b,k).then(function(){var a=b.Deferred();return j=j.join(";\n"),o.length>0?d.get_strings(o).done(function(b){var c;for(c=0;c<b.length;c++){for(;m.indexOf("[[_s"+c+"]]")!==-1;)m=m.replace("[[_s"+c+"]]",b[c]);for(;j.indexOf("[[_s"+c+"]]")!==-1;)j=j.replace("[[_s"+c+"]]",b[c])}a.resolve()}):a.resolve(),a}).then(function(){i.resolve(m.trim(),j)},function(a){i.reject(a)})}),i.promise()},n=function(a,d){var e=b.Deferred(),f=a.split("/"),i=f.shift(),j=f.shift(),m=g.theme+"/"+a;if(m in k)return e.resolve(k[m]),e.promise();var n=h.get("core_template/"+m);if(n)return e.resolve(n),k[m]=n,e.promise();if(m in l)return l[m].promise();l[m]=e;var o=c.call([{methodname:"core_output_load_template",args:{component:i,template:j,themename:g.theme}}],d,!1);return o[0].done(function(a){h.set("core_template/"+m,a),k[m]=a,e.resolve(a)}).fail(function(a){e.reject(a)}),e.promise()},o=function(a){if(""!==a.trim()){var c=b("<script>").attr("type","text/javascript").html(a);b("head").append(c)}},p=function(a,c,d,e){var f=b(a);if(f.length){var g=b(c);e?(f.empty(),f.append(g)):f.replaceWith(g),o(d),i.notifyFilterContentUpdated(g)}},q=function(a,c,d,e){var g={};g.classes=d||"",g=b.extend(g,e),Boolean(c)&&("[object Object]"===c.toString()?g=b.extend(g,c):g.alt=c);var h=b.Deferred();return j.getFlexTemplateData(a).done(function(a){"undefined"==typeof a.data&&(a.data={}),a.data.customdata=g,t.render(a.template,a.data).done(function(a){h.resolve(a)})}).fail(function(){var b=a.split("|");1===b.length&&b.unshift("core");var c=f.imageUrl(b[1],b[0]),d=[{name:"src",value:c},{name:"alt",value:g.alt},{name:"title",value:g.alt},{name:"class",value:"smallicon "+g.classes}];delete g.alt,delete g.classes;for(var e in g)d.push({name:e,value:g[e]});t.render("core/pix_icon",{attributes:d}).done(h.resolve)}),h.promise()},r=function(a,c,d){var e=b(a);e.length&&(e.prepend(c),o(d),i.notifyFilterContentUpdated(e))},s=function(a,c,d){var e=b(a);e.length&&(e.append(c),o(d),i.notifyFilterContentUpdated(e))},t={render:function(a,c,d){var e=b.Deferred(),f=b.extend({},c),g=n(a,!0);return g.done(function(a){var b=m(a,f);b.done(function(a,b){e.resolve(a,b)}).fail(function(a){e.reject(a)})}).fail(function(a){e.reject(a)}),e},runTemplateJS:o,replaceNodeContents:function(a,b,c){return p(a,b,c,!0)},replaceNode:function(a,b,c){return p(a,b,c,!1)},prependNodeContents:function(a,b,c){r(a,b,c)},appendNodeContents:function(a,b,c){s(a,b,c)},renderIcon:q};return t});