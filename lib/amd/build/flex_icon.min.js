define(["jquery","core/config","core/localstorage","core/ajax"],function(a,b,c,d){var e=!1,f=!1,g=null,h=function(){var h="core_flex_icon/"+b.theme+"/cache",i=a.Deferred();e=!0,g=i.promise();var j=c.get(h);j?(f=JSON.parse(j),i.resolve()):a.when.apply(this,d.call([{methodname:"core_output_get_flex_icons",args:{themename:b.theme}}],!0,!1)).done(function(a){c.set(h,JSON.stringify(a)),f=a,i.resolve()})},i={getFlexTemplateData:function(b){var c=a.Deferred(),d=c.promise(),e=function(){if(!f.icons.hasOwnProperty(b))return void c.reject();var d=f.icons[b],e={data:a.extend({},f.datas[d[1]]),template:f.templates[d[0]]};e.data.identifier=b,c.resolve(e)};return g.done(e),d},getIconData:function(c,d,e){var f,g=a.Deferred(),h=g.promise(),i=this;"undefined"==typeof e&&(e={}),d&&""!==d&&"moodle"!==d&&"core"!==d?f=d+"|"+c:(f=c,d="core"),"undefined"==typeof e.title&&"undefined"!=typeof e.alt&&(e.title=e.alt);var j=function(a){a.data.customdata=e,g.resolve({context:a.data,template:a.template})},k=function(){var a=[],f="";for(var h in e)"class"===h&&e.hasOwnProperty(h)?f=e[h]:e.hasOwnProperty(h)&&a.push({name:h,value:e[h]});var i=b.wwwroot+"/theme/image.php";i+=b.themerev>0&&1==b.slasharguments?"/"+b.theme+"/"+d+"/"+b.themerev+"/"+c:"?theme="+b.theme+"&component="+d+"&rev="+b.themerev+"&image="+c,a.push({name:"src",value:i}),g.resolve({template:"core/pix_icon",context:{attributes:a,extraclasses:f}})};return this.getFlexTemplateData(f).then(j).fail(function(){f===d+"|"+c?k():(f=d+"|"+c,i.getFlexTemplateData(f).then(j).fail(k))}),h}};return e||h(),i});