define(["jquery","core/config","core/notification","core/templates","core/flex_icon"],function(a,b,c,d,e){var f,g,h,i,j={ADDROLE:"a.allowlink, a.prohibitlink",REMOVEROLE:"a.preventlink, a.unprohibitlink",UNPROHIBIT:"a.unprohibitlink"},k=a.Event("rolesloaded"),l=null,m=function(){var d={contextid:f,getroles:1,sesskey:b.sesskey};a.post(h+"roles/ajax.php",d,null,"json").done(function(b){try{i=b,m=function(){a("body").trigger(k)},m()}catch(d){c.exception(d)}}).fail(function(a,b,d){c.exception(d)})},n=function(b,g,j){var k={contextid:f,roleid:g,sesskey:M.cfg.sesskey,action:j,capability:b.data("name")};a.post(h+"roles/ajax.php",k,null,"json").done(function(f){var j=f;try{var k={rolename:i[g],roleid:g,adminurl:h,imageurl:"delete-ns"};switch(j){case"allow":k.spanclass="label label-success allowed",k.linkclass="preventlink",k.action="prevent";break;case"prohibit":k.spanclass="label label-danger forbidden",k.linkclass="unprohibitlink",k.action="unprohibit";break;case"prevent":return void b.find('a[data-role-id="'+g+'"]').first().closest(".allowed").remove();case"unprohibit":return void b.find('a[data-role-id="'+g+'"]').first().closest(".forbidden").remove();default:return}e.getIconData("delete-ns","",{alt:k.action}).then(function(a){return k.deleteicon=a,d.render("core/permissionmanager_role",k)}).then(function(c){if("allow"==j)a(c).insertBefore(b.find(".allowmore:first"));else if("prohibit"==j){a(c).insertBefore(b.find(".prohibitmore:first"));var d=b.find(".allowedroles").first().find('a[data-role-id="'+g+'"]');d&&d.first().closest(".allowed").remove()}l.hide()}).fail(c.exception)}catch(m){c.exception(m)}}).fail(function(a,b,d){c.exception(d)})},o=function(b){b.preventDefault(),a("body").one("rolesloaded",function(){var e=a(b.currentTarget),f=e.data("action"),h=e.closest("tr.rolecap"),k={cap:h.data("humanname"),context:g},m=M.util.get_string("role"+f+"info","core_role",k);null===l&&(l=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,width:"450px"})),l.set("headerContent",M.util.get_string("role"+f+"header","core_role"));var o,p,q=[];switch(f){case"allow":p=h.find(j.REMOVEROLE);break;case"prohibit":p=h.find(j.UNPROHIBIT)}for(o in i){var r="",s=p.filter("[data-role-id='"+o+"']").length;s&&(r="disabled");var t={roleid:o,rolename:i[o],disabled:r};q.push(t)}d.render("core/permissionmanager_panelcontent",{message:m,roles:q}).done(function(b){l.set("bodyContent",b),l.show(),a("div.role_buttons").delegate("input","click",function(b){var c=a(b.currentTarget).data("role-id");n(h,c,f)})}).fail(c.exception)}),m()},p=function(b){b.preventDefault(),a("body").one("rolesloaded",function(){var d=a(b.currentTarget),e=d.data("action"),f=d.data("role-id"),h=d.closest("tr.rolecap"),j={role:i[f],cap:h.data("humanname"),context:g};c.confirm(M.util.get_string("confirmunassigntitle","core_role"),M.util.get_string("confirmrole"+e,"core_role",j),M.util.get_string("confirmunassignyes","core_role"),M.util.get_string("confirmunassignno","core_role"),function(){n(h,f,e)})}),m()};return{initialize:function(b){f=b.contextid,g=b.contextname,h=b.adminurl;var c=a("body");c.delegate(j.ADDROLE,"click",o),c.delegate(j.REMOVEROLE,"click",p)}}});