define(["jquery","core/config","core/notification","core/templates","core/flex_icon","core/yui"],function(a,b,c,d,e,f){var g,h,i,j,k={ADDROLE:"a.allowlink, a.prohibitlink",REMOVEROLE:"a.preventlink, a.unprohibitlink",UNPROHIBIT:"a.unprohibitlink"},l=a.Event("rolesloaded"),m=null,n=function(){var d={contextid:g,getroles:1,sesskey:b.sesskey};a.post(i+"roles/ajax.php",d,null,"json").done(function(b){try{j=b,n=function(){a("body").trigger(l)},n()}catch(d){c.exception(d)}}).fail(function(a,b,d){c.exception(d)})},o=function(b,f,h){var k={contextid:g,roleid:f,sesskey:M.cfg.sesskey,action:h,capability:b.data("name")};a.post(i+"roles/ajax.php",k,null,"json").done(function(g){var h=g;try{var k={rolename:j[f],roleid:f,adminurl:i,imageurl:"delete-ns"};switch(h){case"allow":k.spanclass="label label-success allowed",k.linkclass="preventlink",k.action="prevent";break;case"prohibit":k.spanclass="label label-danger forbidden",k.linkclass="unprohibitlink",k.action="unprohibit";break;case"prevent":return void b.find('a[data-role-id="'+f+'"]').first().closest(".allowed").remove();case"unprohibit":return void b.find('a[data-role-id="'+f+'"]').first().closest(".forbidden").remove();default:return}e.getIconData("delete-ns","",{alt:k.action}).then(function(a){return k.deleteicon=a,d.render("core/permissionmanager_role",k)}).then(function(c){if("allow"==h)a(c).insertBefore(b.find(".allowmore:first"));else if("prohibit"==h){a(c).insertBefore(b.find(".prohibitmore:first"));var d=b.find(".allowedroles").first().find('a[data-role-id="'+f+'"]');d&&d.first().closest(".allowed").remove()}m.hide()}).fail(c.exception)}catch(l){c.exception(l)}}).fail(function(a,b,d){c.exception(d)})},p=function(b){b.preventDefault(),f.use("moodle-core-notification-dialogue",function(){a("body").one("rolesloaded",function(){var e=a(b.currentTarget),f=e.data("action"),g=e.closest("tr.rolecap"),i={cap:g.data("humanname"),context:h},l=M.util.get_string("role"+f+"info","core_role",i);null===m&&(m=new M.core.dialogue({draggable:!0,modal:!0,closeButton:!0,width:"450px"})),m.set("headerContent",M.util.get_string("role"+f+"header","core_role"));var n,p,q=[];switch(f){case"allow":p=g.find(k.REMOVEROLE);break;case"prohibit":p=g.find(k.UNPROHIBIT)}for(n in j){var r="",s=p.filter("[data-role-id='"+n+"']").length;s&&(r="disabled");var t={roleid:n,rolename:j[n],disabled:r};q.push(t)}d.render("core/permissionmanager_panelcontent",{message:l,roles:q}).done(function(b){m.set("bodyContent",b),m.show(),a("div.role_buttons").delegate("input","click",function(b){var c=a(b.currentTarget).data("role-id");o(g,c,f)})}).fail(c.exception)})}),n()},q=function(b){b.preventDefault(),a("body").one("rolesloaded",function(){var d=a(b.currentTarget),e=d.data("action"),f=d.data("role-id"),g=d.closest("tr.rolecap"),i={role:j[f],cap:g.data("humanname"),context:h};c.confirm(M.util.get_string("confirmunassigntitle","core_role"),M.util.get_string("confirmrole"+e,"core_role",i),M.util.get_string("confirmunassignyes","core_role"),M.util.get_string("confirmunassignno","core_role"),function(){o(g,f,e)})}),n()};return{initialize:function(b){g=b.contextid,h=b.contextname,i=b.adminurl;var c=a("body");c.delegate(k.ADDROLE,"click",p),c.delegate(k.REMOVEROLE,"click",q)}}});